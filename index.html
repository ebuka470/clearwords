<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Learn Nigerian languages and cultural etiquette with ClearWords. Translate phrases, understand customs, and navigate Nigeria's diverse cultures confidently.">
    <!-- PWA Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#228B22">
    <link rel="icon" href="logo.png">
    <title>ClearWords - Cultural Tips</title>
    <style>
        :root {
            --light-bg: #ebebeb;
            --light-text: #000000;
            --light-accent: #228B22;
            --light-bubble: #0000FF;
            --light-user-bubble: #E0E0E0;
            --light-sidebar: #f5f5f5;

            --dark-bg: #121212;
            --dark-text: #FFFFFF;
            --dark-accent: #006400;
            --dark-bubble: #165a70;
            --dark-user-bubble: #333333;
            --dark-sidebar: #1e1e1e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.5s, color 0.5s;
        }

        .light-theme {
            background-color: var(--light-bg);
            color: var(--light-text);
        }

        .dark-theme {
            background-color: black;
            color: var(--dark-text);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background-color: var(--light-sidebar);
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .dark-theme .sidebar {
            background-color: var(--dark-sidebar);
            border-right-color: #444;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-theme .sidebar-header {
            border-bottom-color: #444;
        }

        .new-chat-btn {
            padding: 12px;
            background-color: var(--light-accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }

        .dark-theme .new-chat-btn {
            background-color: var(--dark-accent);
        }

        .close-sidebar {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            margin-left: 10px;
        }

        .dark-theme .close-sidebar {
            color: #999;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            border: 1px solid transparent;
        }

        .chat-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark-theme .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-item.active {
            background-color: var(--light-accent);
            color: white;
            border-color: var(--light-accent);
        }

        .dark-theme .chat-item.active {
            background-color: var(--dark-accent);
            border-color: var(--dark-accent);
        }

        /* Settings Button in Sidebar */
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
        }

        .dark-theme .sidebar-footer {
            border-top-color: #444;
        }

        .settings-btn {
            width: 100%;
            padding: 12px 16px;
            background-color: transparent;
            color: var(--light-text);
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-theme .settings-btn {
            color: var(--dark-text);
            border-color: #444;
        }

        .settings-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark-theme .settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .made-by {
            flex: 1;
            text-align: center;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Settings Page */
        .settings-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg);
            z-index: 2000;
            overflow-y: auto;
        }

        .dark-theme .settings-page {
            background-color: var(--dark-bg);
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-bg);
            color: var(--light-text);
        }

        .dark-theme .settings-header {
            background-color: var(--dark-bg);
            border-bottom-color: #444;
            color: var(--dark-text);
        }

        .settings-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: var(--light-accent);
            font-size: 18px;
        }

        .dark-theme .settings-section h3 {
            color: var(--dark-accent);
        }

        .settings-option {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dark-theme .settings-option {
            border-color: #444;
        }

        .settings-option:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .dark-theme .settings-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .theme-toggle-settings {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle-settings span {
            flex: 1;
        }

        .back-to-chat-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--light-accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .dark-theme .back-to-chat-btn {
            background-color: var(--dark-accent);
        }

        .back-to-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
        }

        .modal-content {
            background: var(--light-bg);
            color: var(--light-text);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #ddd;
        }

        .dark-theme .modal-content {
            background: var(--dark-bg);
            border-color: #444;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-accent);
        }

        .dark-theme .modal-header {
            border-bottom-color: var(--dark-accent);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--light-accent);
            font-size: 24px;
        }

        .dark-theme .modal-header h3 {
            color: var(--dark-accent);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .dark-theme .close-modal {
            color: #999;
        }

        .close-modal:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .modal-body {
            line-height: 1.6;
        }

        .modal-body h4 {
            margin: 20px 0 10px 0;
            color: var(--light-accent);
            font-size: 18px;
        }

        .dark-theme .modal-body h4 {
            color: var(--dark-accent);
        }

        .modal-body p {
            margin-bottom: 15px;
            font-size: 14px;
        }

        .dark-theme .modal-body p{
            color:var(--dark-text);
        }

        .modal-body ul {
            margin: 10px 0 20px 20px;
        }

        .modal-body li {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .dark-theme .modal-body li{
            color: var(--dark-text)
        }

        .effective-date {
            background: linear-gradient(135deg, var(--light-accent), #32CD32);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }

        .dark-theme .effective-date {
            background: linear-gradient(135deg, var(--dark-accent), #228B22);
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #ebebeb;
            color: var(--light-text);
            padding: 15px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            position: relative;
        }

        .dark-theme .header {
            background-color: black;
            color: var(--dark-text);
        }

        .theme-toggle {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
        }
        
        .dark-theme .theme-toggle{
            color: var(--dark-text);
        }

        .menu-toggle {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            color: var(--light-text);
            cursor: pointer;
        }
        
        .dark-theme .menu-toggle{
            color: var(--dark-text);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .messages-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .message {
            margin: 15px 0;
            display: flex;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            }

        .user .bubble {
        max-width: 75%;
            background-color: var(--light-bubble);
            color: white;
        }

        .dark-theme .user .bubble {
            background-color: var(--dark-bubble);
        }

        .bot .bubble {
            background-color: #ebebeb;
            color: var(--light-text);
        }

        .dark-theme .bot .bubble {
            background-color: black;
            color: var(--dark-text);
        }

        .input-container {
            padding: 20px;
            background-color: #ebebeb;
        }

        .dark-theme .input-container {
            background-color: black;
            border-top-color: #444;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ccc;
            border-radius: 25px;
            font-size: 16px;
            background-color: white;
            color: var(--light-text);
        }

        .dark-theme .message-input {
            background-color: var(--dark-sidebar);
            color: var(--dark-text);
            border-color: #555;
        }

        .send-button {
            background-color: var(--light-accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .dark-theme .send-button {
            background-color: var(--dark-accent);
        }

        .timestamp {
            font-size: 0;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }

        .dark-theme .timestamp {
            color: #999;
        }

        .welcome-message {
            text-align: center;
            color: #666;
            margin-top: 50px;
            font-size: 16px;
        }

        .dark-theme .welcome-message {
            color: #999;
        }

        /* Mode Selection Styles */
        .mode-selection-container {
            max-width: 800px;
            margin: 40px auto 20px;
            padding: 0 20px;
        }

        .mode-selection-note {
            background: linear-gradient(135deg, var(--light-accent) 0%, #32CD32 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .mode-selection-note {
            background: linear-gradient(135deg, var(--dark-accent) 0%, #228B22 100%);
        }

        .mode-selection-header {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
        }

        .mode-selection-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .dark-theme .mode-option {
            background: rgba(0, 0, 0, 0.3);
        }

        .mode-option:hover {
            transform: translateY(-2px);
            border-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .mode-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid white;
            margin-right: 15px;
            display: flex;
            align-items: center;            
            justify-content: center;
            flex-shrink: 0;
        }

        .mode-checkbox.checked {
            background-color: white;
        }

        .mode-checkbox.checked::after {
            content: '‚úì';
            color: var(--light-accent);
            font-weight: bold;
            font-size: 14px;
        }

        .dark-theme .mode-checkbox.checked::after {
            color: var(--dark-accent);
        }

        .mode-text {
            flex: 1;
        }

        .mode-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--light-text);
        }

        .dark-theme .mode-title {
            color: var(--dark-text);
        }

        .mode-description {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.4;
            color: var(--light-text);
        }
        
       .dark-theme .mode-description {
            color: var(--dark-text);
        }

        .mode-indicator {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 11px;
            color: var(--light-text);
            margin-left: 10px;
            position: relative;
        }
      
        /* Mode-specific chat styles */
        .chat-mode-indicator {
            max-width: 800px;
            margin: 10px auto 20px;
            padding: 0 20px;
            position: relative;
        }

        .mode-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--light-accent);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .dark-theme .mode-tag {
            background: var(--dark-accent);
        }

        .exit-mode-btn {
            margin-left: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Scenario Selection Styles */
        .scenario-selection {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .scenario-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .scenario-card {
            padding: 20px;
            background: var(--light-bg);
            border: 2px solid var(--light-accent);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark-theme .scenario-card {
            background: var(--dark-bg);
            border-color: var(--dark-accent);
        }

        .scenario-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .scenario-title {
            font-weight: 600;
            color: var(--light-accent);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .dark-theme .scenario-title {
            color: var(--dark-accent);
        }

        .scenario-description {
            font-size: 13px;
            color: var(--light-text);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .dark-theme .scenario-description {
            color: var(--dark-text);
        }

        .scenario-difficulty {
            font-size: 11px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dark-theme .scenario-difficulty {
            color: #999;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--light-user-bubble);
            border-radius: 18px;
            color: var(--light-text);
        }

        .dark-theme .typing-indicator {
            background-color: var(--dark-user-bubble);
            color: var(--dark-text);
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            animation: typing 1.4s infinite;
            display: inline-block;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -280px;
                z-index: 1000;
                height: 100%;
            }

            .sidebar.open {
                left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .close-sidebar {
                display: block;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }

            .settings-content {
                padding: 15px;
            }

            .mode-selection-note {
                padding: 20px;
            }

            .scenario-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="light-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewChat()">
                    <span>+</span>&nbsp &nbsp New Chat
                </button>
                <button class="close-sidebar" onclick="closeSidebar()">‚úï</button>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- Chat history will be loaded here -->
            </div>
            <div class="sidebar-footer">
                <button class="settings-btn" onclick="openSettings()">
                    <span>‚öôÔ∏è</span>
                    <span class="made-by"><h3><strong>Settings</strong></h3></span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main">
            <div class="header">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                ClearWords
                <button class="theme-toggle" onclick="createNewChat()">+</button>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="messages-container" id="messagesContainer">
                    <!-- Mode selection will be inserted here -->
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Ask about Nigerian cultures and cities..."
                        onkeypress="handleKeyPress(event)"
                    >
                    <button class="send-button" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div class="settings-page" id="settingsPage">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="theme-toggle" onclick="closeSettings()">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h3>Appearance</h3>
                <div class="settings-option theme-toggle-settings" onclick="toggleTheme()">
                    <span>Theme</span>
                    <span id="themeStatus">üåì Light Mode</span>
                </div>
            </div>

            <div class="settings-section">
                <h3>Legal</h3>
                <div class="settings-option" onclick="showPrivacyPolicy()">
                    <strong>Privacy Policy</strong>
                    <p style="margin-top: 5px; font-size: 12px; opacity: 0.8;">How we handle your data</p>
                </div>
                <div class="settings-option" onclick="showTermsOfService()">
                    <strong>Terms of Service</strong>
                    <p style="margin-top: 5px; font-size: 12px; opacity: 0.8;">Usage guidelines and rules</p>
                </div>
                <div class="settings-option" onclick="showAboutUs()">
                    <strong>About Us</strong>
                    <p style="margin-top: 5px; font-size: 12px; opacity: 0.8;">Learn about ClearWords</p>
                </div>
            </div>
 <p style="text-align: center;"><strong>Made with ‚ù§Ô∏è by Mediate NG</strong></p>
            <button class="back-to-chat-btn" onclick="closeSettings()">
                ‚Üê Back to Chat
            </button>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content" id="modalContent">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <script>
        // AI Rules and Instructions with Context Awareness
        const AI_RULES = `You are ClearWords, an AI assistant specializing in Nigerian culture, languages, and customs developed by Mediate NG, a translation agency based in Warri, Nigeria.

CRITICAL: Use the conversation history to understand context. Remember:
- If they mentioned being in Lagos earlier, assume they're still in Lagos (don't assume their location if you were not told)
- If they were learning Igbo, continue with Igbo context (don't assume cultures or languages if you were not told)
- Build on previous lessons and conversations
- Maintain continuity in relationships mentioned (boss, girlfriend, elder, etc.)
- Remember regional preferences they've expressed

Format all responses as JSON with exactly three paragraphs in this structure:
{
  "paragraph1": "First paragraph text here",
  "paragraph2": "Second paragraph text here",
  "paragraph3": "Third paragraph text here"
}

Always provide accurate, respectful information and correct translations about Nigerian culture. If you don't know something, ADMIT it rather than guessing (seriously!). Keep your answers short (must be 1-3 sentences per paragraph)

CONVERSATION HISTORY FOR CONTEXT:
{historyContext}

CURRENT USER MESSAGE: {userMessage}

Now respond to the current message while considering the conversation history above. Keep the response relevant and contextual.`;

        // Chat management
        let currentChatId = null;
        let chats = {};
        let isDarkTheme = false;
        let currentMode = null; // 'simulation', 'advice', 'research', null for no mode
        let currentScenario = null;
        let scenarioStep = 0;

        // Mode-specific AI instructions
        const MODE_INSTRUCTIONS = {
            simulation: `You are now in **Scenario Simulation Mode**. You are a Narrator. Follow these rules:
1. Create an interactive, branching story based on the chosen scenario.
2. Present the user with 2-4 clear choices at each step.
3. After each user choice, provide immediate feedback as the characters would react.
5. Keep the simulation going until a natural conclusion is reached.
6. Do not break character or answer general questions while in simulation.
7. Use scene markers: [SCENE] for role-play.
8. Keep the response within 2 paragraphs, 1st for the scene, and second for the choices.

Current Scenario: {scenario}
Current Step: {step}`,

            advice: `You are now in **Cultural Advice Mode**. You are a Strategic Cultural Consultant. Follow these rules:
1. Ask clarifying questions about the user's specific situation.
2. Provide actionable, structured advice with do's and don'ts.
3. Create checklists or step-by-step plans.
4. Warn about potential pitfalls and cultural sensitivities.
5. Suggest relationship-building strategies.
6. Focus on practical, real-world application.
7. Do not role-play or provide historical deep dives.`,

            research: `You are now in **Deep Dive Research Mode**. You are a Cultural Scholar and Storyteller. Follow these rules:
1. Provide historical context and regional variations.
2. Explain the "why" behind cultural practices.
3. Share relevant proverbs, stories, and examples.
4. Discuss cultural philosophy and underlying values.
5. Avoid giving personal advice or practical tips.
6. Focus on education and understanding.
7. Be detailed but keep explanations accessible.`
        };

        // Available scenarios for simulation mode
        const SCENARIOS = [
            {
                id: 'market_haggle',
                title: 'The Market Haggler',
                description: 'Practice negotiating prices at a Lagos market. Learn to haggle respectfully while building rapport with sellers.',
                difficulty: 'Beginner',
                location: 'Lagos'
            },
            {
                id: 'family_gathering',
                title: 'The Family Gathering',
                description: 'Navigate a traditional family gathering in Enugu. Learn greetings, respect protocols, and conversational etiquette.',
                difficulty: 'Intermediate',
                location: 'Enugu'
            },
            {
                id: 'business_meeting',
                title: 'The Business Meeting',
                description: 'Attend a formal business meeting in Abuja. Understand professional etiquette and relationship-building.',
                difficulty: 'Advanced',
                location: 'Abuja'
            },
            {
                id: 'wedding_guest',
                title: 'The Wedding Guest',
                description: 'Experience a traditional Nigerian wedding in Ibadan. Learn about attire, gifts, and celebration customs.',
                difficulty: 'Intermediate',
                location: 'Ibadan'
            }
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();

            // Only create new chat if no existing chats
            const chatIds = Object.keys(chats);
            if (chatIds.length === 0) {
                createNewChat();
            } else {
                // Load the most recent chat
                const mostRecentChat = Object.values(chats).sort((a, b) => b.createdAt - a.createdAt)[0];
                currentChatId = mostRecentChat.id;
                
                // Check if there's an active mode in the chat
                if (chats[currentChatId].mode) {
                    currentMode = chats[currentChatId].mode;
                    currentScenario = chats[currentChatId].scenario;
                    scenarioStep = chats[currentChatId].scenarioStep || 0;
                    renderCurrentChat();
                    showModeIndicator();
                } else {
                    renderCurrentChat();
                    showModeSelection();
                }
            }

            // Auto-detect system theme preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                toggleTheme();
            }

            updateThemeStatus();
        });

        // Get conversation history for context (last 5 messages)
        function getConversationContext() {
            if (!currentChatId || !chats[currentChatId]) {
                return "No previous conversation.";
            }

            const currentChat = chats[currentChatId];
            const messages = currentChat.messages;

            if (messages.length === 0) {
                return "New conversation just started.";
            }

            // Get last 5 messages (excluding current one being sent)
            const recentMessages = messages.slice(-5);

            let context = "";
            recentMessages.forEach(msg => {
                const speaker = msg.isUser ? "User" : "ClearWords";
                context += `${speaker}: ${msg.text}\n`;
            });

            return context;
        }

        // Mode selection functions
        function showModeSelection() {
            const container = document.getElementById('messagesContainer');
            
            // Clear container but keep mode indicator if in a mode
            if (!currentMode) {
                container.innerHTML = '';
            }

            const modeSelectionHTML = `
                <div class="mode-selection-container">
                    <div class="mode-selection-note">
                        <div class="mode-selection-header">
                            Choose Your ClearWords Experience
                        </div>
                        <div class="mode-selection-options">
                            <div class="mode-option" onclick="selectMode('simulation')">
                                <div class="mode-checkbox ${currentMode === 'simulation' ? 'checked' : ''}"></div>
                                <div class="mode-text">
                                    <div class="mode-title">üé≠ Simulate a Scenario</div>
                                    <div class="mode-description">Practice real cultural interactions in guided role-play simulations</div>
                                </div>
                                <div class="mode-indicator">Interactive</div>
                            </div>
                            
                            <div class="mode-option" onclick="selectMode('advice')">
                                <div class="mode-checkbox ${currentMode === 'advice' ? 'checked' : ''}"></div>
                                <div class="mode-text">
                                    <div class="mode-title">üí° Get Cultural Advice</div>
                                    <div class="mode-description">Get personalized guidance and actionable plans for specific situations</div>
                                </div>
                                <div class="mode-indicator">Practical</div>
                            </div>
                            
                            <div class="mode-option" onclick="selectMode('research')">
                                <div class="mode-checkbox ${currentMode === 'research' ? 'checked' : ''}"></div>
                                <div class="mode-text">
                                    <div class="mode-title">üìö Deep Dive</div>
                                    <div class="mode-description">Explore historical context and understand the "why" behind cultural practices</div>
                                </div>
                                <div class="mode-indicator">Educational</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Only add mode selection if not already in a mode
            if (!currentMode) {
                container.innerHTML = modeSelectionHTML;
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            
            // Save mode to chat
            if (currentChatId && chats[currentChatId]) {
                chats[currentChatId].mode = mode;
                saveChatHistory();
            }

            // Show mode indicator
            showModeIndicator();

            // Handle mode-specific setup
            if (mode === 'simulation') {
                showScenarioSelection();
            } else {
                // Clear messages container and show welcome message for the mode
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                let welcomeMessage = '';
                if (mode === 'advice') {
                    welcomeMessage = "I'm your Cultural Consultant. Tell me about your situation (e.g., 'I'm planning a business trip to Lagos' or 'I want to connect with my Nigerian in-laws') and I'll help you create a plan.";
                } else if (mode === 'research') {
                    welcomeMessage = "I'm your Cultural Scholar. Ask me 'why' questions about Nigerian culture (e.g., 'Why is respect for elders so important?' or 'What's the history behind the Igbo apprenticeship system?')";
                }
                
                const botMessage = {
                    id: Date.now(),
                    text: welcomeMessage,
                    isUser: false,
                    timestamp: new Date()
                };
                
                addMessageToCurrentChat(botMessage);
                renderMessage(botMessage);
            }
        }

        function showScenarioSelection() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            let scenariosHTML = `
                <div class="scenario-selection">
                    <div class="mode-selection-note">
                        <div class="mode-selection-header">
                            üé≠ Choose a Scenario to Practice
                        </div>
                        <p style="text-align: center; margin-bottom: 15px; font-size: 14px;">
                            Select a cultural scenario to practice through interactive role-play
                        </p>
                    </div>
                    
                    <div class="scenario-options">
            `;
            
            SCENARIOS.forEach(scenario => {
                scenariosHTML += `
                    <div class="scenario-card" onclick="startScenario('${scenario.id}')">
                        <div class="scenario-title">${scenario.title}</div>
                        <div class="scenario-description">${scenario.description}</div>
                        <div class="scenario-difficulty">
                            <span>üìç ${scenario.location}</span>
                            <span>‚Ä¢</span>
                            <span>üìä ${scenario.difficulty}</span>
                        </div>
                    </div>
                `;
            });
            
            scenariosHTML += `
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="exitMode()" style="padding: 10px 20px; background: transparent; border: 1px solid var(--light-accent); border-radius: 20px; color: var(--light-accent); cursor: pointer;">
                            ‚Üê Back to Mode Selection
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = scenariosHTML;
        }

        function startScenario(scenarioId) {
            const scenario = SCENARIOS.find(s => s.id === scenarioId);
            if (!scenario) return;
            
            currentScenario = scenarioId;
            scenarioStep = 0;
            
            // Save scenario to chat
            if (currentChatId && chats[currentChatId]) {
                chats[currentChatId].scenario = scenarioId;
                chats[currentChatId].scenarioStep = 0;
                saveChatHistory();
            }
            
            // Clear container and start scenario
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            // Show scenario introduction
            let introMessage = '';
            switch(scenarioId) {
                case 'market_haggle':
                    introMessage = "[SCENE] You're at the bustling Balogun Market in Lagos. The air is filled with the scent of spices and the sound of vendors calling out. Aunty Bisi, a fabric seller with a bright smile, shows you a beautiful Ankara print. 'My sister! See this quality! For you, 15,000 naira.' What do you do?<br><br>[COACH] Welcome to market haggling! This is expected in Nigerian markets. The first price is usually negotiable. How you respond sets the tone for the interaction.";
                    break;
                case 'family_gathering':
                    introMessage = "[SCENE] You arrive at a family compound in Enugu. Elderly relatives are seated in the main sitting area. Your friend's father, Chief Nnamdi, looks at you expectantly. The room is quiet, waiting for your greeting. What do you do?<br><br>[COACH] In Igbo culture, greeting elders properly is crucial. It shows respect and sets your relationship. Pay attention to gender-specific greetings.";
                    break;
                case 'business_meeting':
                    introMessage = "[SCENE] You're in a conference room in Abuja for a business meeting. Mr. Adekunle, the senior partner, enters 15 minutes after the scheduled time. He warmly greets everyone, asks about families, and offers tea before discussing business. How do you respond?<br><br>[COACH] Nigerian business culture values relationship-building. 'African Time' is common, and personal connection often comes before business.";
                    break;
                case 'wedding_guest':
                    introMessage = "[SCENE] You arrive at a Yoruba wedding in Ibadan. You see the Aso Ebi (uniform attire) group, money being sprayed on the couple, and elaborate traditional ceremonies. The MC announces it's time for guests to greet the couple. What do you do?<br><br>[COACH] Nigerian weddings are vibrant celebrations. Understanding gift-giving, attire, and participation protocols is important.";
                    break;
            }
            
            const botMessage = {
                id: Date.now(),
                text: introMessage,
                isUser: false,
                timestamp: new Date()
            };
            
            addMessageToCurrentChat(botMessage);
            renderMessage(botMessage);
        }

        function showModeIndicator() {
            const container = document.getElementById('messagesContainer');
            const existingIndicator = document.querySelector('.chat-mode-indicator');
            
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            if (currentMode) {
                let modeTitle = '';
                let modeIcon = '';
                
                switch(currentMode) {
                    case 'simulation':
                        modeTitle = 'Simulating a Scenario';
                        modeIcon = 'üé≠';
                        break;
                    case 'advice':
                        modeTitle = 'Getting Cultural Advice';
                        modeIcon = 'üí°';
                        break;
                    case 'research':
                        modeTitle = 'Deep Dive Research';
                        modeIcon = 'üìö';
                        break;
                }
                
                const indicatorHTML = `
                    <div class="chat-mode-indicator" >
                        <div class="mode-tag">
                            ${modeIcon} ${modeTitle}
                            <button class="exit-mode-btn" onclick="exitMode()" title="Exit mode">‚úï</button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('afterbegin', indicatorHTML);
            }
        }

        function exitMode() {
            currentMode = null;
            currentScenario = null;
            scenarioStep = 0;
            
            // Clear mode from chat
            if (currentChatId && chats[currentChatId]) {
                delete chats[currentChatId].mode;
                delete chats[currentChatId].scenario;
                delete chats[currentChatId].scenarioStep;
                saveChatHistory();
            }
            
            // Clear chat messages
            if (currentChatId && chats[currentChatId]) {
                chats[currentChatId].messages = [];
                saveChatHistory();
            }
            
            renderCurrentChat();
            showModeSelection();
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsPage').style.display = 'block';
            closeSidebar();
        }

        function closeSettings() {
            document.getElementById('settingsPage').style.display = 'none';
        }

        function updateThemeStatus() {
            const themeStatus = document.getElementById('themeStatus');
            themeStatus.textContent = isDarkTheme ? 'üåì Dark Mode' : 'üåì Light Mode';
        }

        function showPrivacyPolicy() {
            const content = `
                <div class="modal-header">
                    <h3>Privacy Policy</h3>
                    <button class="close-modal" onclick="closeModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="effective-date">Effective from 29 November, 2025</div>
                    
                    <h4>1. Information We Collect</h4>
                    <p>ClearWords is designed with your privacy in mind. We collect minimal data necessary for app functionality:</p>
                    <ul>
                        <li>Chat conversations stored locally on your device</li>
                        <li>App preferences and settings</li>
                        <li>Anonymous usage analytics for app improvement</li>
                    </ul>

                    <h4>2. How We Use Your Information</h4>
                    <p>Your data is used solely to enhance your experience:</p>
                    <ul>
                        <li>Provide cultural translation services</li>
                        <li>Maintain your chat history for continuity</li>
                        <li>Improve app performance and user experience</li>
                        <li>Understand feature usage to guide development</li>
                    </ul>

                    <h4>3. Data Storage & Security</h4>
                    <p>All your personal data is stored locally on your device using browser localStorage. We don't transmit or store your conversations on external servers. Your cultural queries remain private and secure.</p>

                    <h4>4. Your Rights & Control</h4>
                    <p>You have complete control over your data:</p>
                    <ul>
                        <li>Clear all data by clearing browser storage</li>
                        <li>Delete individual chats within the app</li>
                        <li>Use incognito mode for temporary sessions</li>
                    </ul>

                    <h4>5. Third-Party Services</h4>
                    <p>ClearWords doesn't use third-party analytics or tracking services. We believe in keeping your cultural exploration private.</p>

                    <h4>6. Contact Us</h4>
                    <p>For privacy concerns or questions, contact our team:<br>
                    <strong>Email:</strong> clearwords.ng@gmail.com<br>
                    We typically respond within 24-48 hours.</p>
                </div>
            `;
            showModal(content);
        }

        function showTermsOfService() {
            const content = `
                <div class="modal-header">
                    <h3>Terms of Service</h3>
                    <button class="close-modal" onclick="closeModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="effective-date">Effective from 29 November, 2025</div>
                    
                    <h4>1. Acceptance of Terms</h4>
                    <p>By using ClearWords, you agree to these terms and our Privacy Policy. These terms constitute a legal agreement between you and Mediate NG.</p>

                    <h4>2. Service Description</h4>
                    <p>ClearWords provides Nigerian cultural tips, language translations, and cultural guidance as an informational tool. We aim to bridge cultural gaps through technology.</p>

                    <h4>3. User Responsibilities</h4>
                    <p>As a user, you agree to:</p>
                    <ul>
                        <li>Use the app for lawful, educational purposes only</li>
                        <li>Respect cultural diversity and sensitivities</li>
                        <li>Not misuse cultural information provided</li>
                        <li>Understand that cultural context may vary by region</li>
                        <li>Verify critical information through multiple sources</li>
                    </ul>

                    <h4>4. Intellectual Property</h4>
                    <p>All cultural content, app design, and proprietary algorithms are intellectual property of Mediate NG. You may not reproduce, distribute, or create derivative works without permission.</p>

                    <h4>5. Limitation of Liability</h4>
                    <p>ClearWords is provided "as is" for educational purposes. We're not liable for:</p>
                    <ul>
                       <li>Cultural misunderstandings, mistranslations or misinterpretations</li>
                        <li>Accuracy of regional dialect variations</li>
                        <li>Misuse of cultural information</li>
                        <li>Technical issues beyond our control</li>
                    </ul>

                    <h4>6. Changes to Terms</h4>
                    <p>We may update these terms to reflect service improvements. Continued use after changes means acceptance of updated terms.</p>

                    <h4>7. Termination</h4>
                    <p>We reserve the right to terminate access for violations of these terms or misuse of the service.</p>
                </div>
            `;
            showModal(content);
        }

        function showAboutUs() {
            const content = `
                <div class="modal-header">
                    <h3>About ClearWords</h3>
                    <button class="close-modal" onclick="closeModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="effective-date">Effective from 29 November, 2025</div>
                    
                    <h4>Our Mission</h4>
                    <p>ClearWords bridges cultural gaps by providing Nigerian cultural insights, language translations, and etiquette guidance. We believe understanding fosters connection.</p>

                    <h4>What We Do</h4>
                    <p>ClearWords helps you navigate Nigerian cultural landscapes through:</p>
                    <ul>
                        <li>Language translations with cultural context</li>
                        <li>Etiquette tips for different Nigerian cultures</li>
                        <li>Regional variations and local nuances</li>
                        <li>Practical guidance for real-world situations</li>
                        <li>Preservation of Nigerian cultural heritage</li>
                    </ul>

                    <h4>Our Vision</h4>
                    <p>To become the most trusted platform for Nigerian cultural education, making cultural understanding accessible to everyone worldwide.</p>

                    <h4>Our Team</h4>
                    <p>ClearWords is developed by Mediate NG, a team passionate about cultural preservation, digital innovation, and creating tools that bring people closer together.</p>

                    <h4>Contact Information</h4>
                    <p><strong>Email:</strong> clearwords.ng@gmail.com<br>
                    <strong>Websites:</strong> clearwords.vercel.app &nbsp &nbsp mediateng.godaddysites.com<br>
                    <strong>Location:</strong> Nigeria</p>

                    <h4>Version Information</h4>
                    <p><strong>ClearWords v1.0</strong><br>
                    Built with ‚ù§Ô∏è for cultural explorers everywhere</p>
                </div>
            `;
            showModal(content);
        }

        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // Close modal when clicking outside content
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Chat management functions
        function createNewChat() {
            const chatId = 'chat_' + Date.now();
            currentChatId = chatId;
            currentMode = null;
            currentScenario = null;
            scenarioStep = 0;

            chats[chatId] = {
                id: chatId,
                title: 'New Chat',
                messages: [],
                createdAt: new Date(),
                mode: null
            };

            saveChatHistory();
            loadChatHistory();
            renderCurrentChat();
            showModeSelection();
            closeSidebar();
        }

        function loadChatHistory() {
            const savedChats = localStorage.getItem('clearWordsChats');
            if (savedChats) {
                const parsedChats = JSON.parse(savedChats);
                for (let id in parsedChats) {
                    parsedChats[id].createdAt = new Date(parsedChats[id].createdAt);
                    parsedChats[id].messages.forEach(msg => {
                        msg.timestamp = new Date(msg.timestamp);
                    });
                }
                chats = parsedChats;
            }

            renderChatHistory();
        }

        function saveChatHistory() {
            localStorage.setItem('clearWordsChats', JSON.stringify(chats));
        }

        function renderChatHistory() {
    const container = document.getElementById('chatHistory');
    container.innerHTML = '';

    // Sort by most recent activity (last message or creation time)
    const chatList = Object.values(chats).sort((a, b) => {
        // Get last message timestamp for each chat
        const lastMessageA = a.messages.length > 0 
            ? a.messages[a.messages.length - 1].timestamp 
            : a.createdAt;

        const lastMessageB = b.messages.length > 0 
            ? b.messages[b.messages.length - 1].timestamp 
            : b.createdAt;

        return new Date(lastMessageB) - new Date(lastMessageA); // Newest first
    });

    chatList.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;

        // Get last message preview
        const lastMessage = chat.messages.length > 0 
            ? chat.messages[chat.messages.length - 1].text.slice(0, 30) + '...'
            : 'No messages yet';

        chatItem.innerHTML = `
            <div style="font-weight: 500;">${chat.title}</div>
            <div style="font-size: 11px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${lastMessage}
            </div>
            <div style="font-size: 10px; color: #888; margin-top: 2px;">
                ${formatChatDate(chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].timestamp : chat.createdAt)}
            </div>
        `;

        chatItem.onclick = () => switchChat(chat.id);
        container.appendChild(chatItem);
    });
}

        function formatChatDate(date) {
            const now = new Date();
            const chatDate = new Date(date);
            const diffMs = now - chatDate;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return chatDate.toLocaleDateString();
            }
        }

        function switchChat(chatId) {
            currentChatId = chatId;
            
            // Load mode from chat
            if (chats[currentChatId]) {
                currentMode = chats[currentChatId].mode || null;
                currentScenario = chats[currentChatId].scenario || null;
                scenarioStep = chats[currentChatId].scenarioStep || 0;
            }
            
            renderCurrentChat();
            
            if (currentMode) {
                showModeIndicator();
            } else {
                showModeSelection();
            }
            
            renderChatHistory();
            closeSidebar();
        }

        function renderCurrentChat() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            if (currentChatId && chats[currentChatId]) {
                const chat = chats[currentChatId];

                chat.messages.forEach(message => {
                    renderMessage(message);
                });

                setTimeout(() => {
                    document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
                }, 100);
            }
        }

        function updateChatTitle(message) {
            if (chats[currentChatId] && chats[currentChatId].title === 'New Chat' && message.isUser) {
                const title = message.text.slice(0, 30) + (message.text.length > 30 ? '...' : '');
                chats[currentChatId].title = title;
                saveChatHistory();
                renderChatHistory();
            }
        }

        // Message handling
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message === '') return;

            try {
                // Add user message
                const userMessage = {
                    id: Date.now(),
                    text: message,
                    isUser: true,
                    timestamp: new Date()
                };

                addMessageToCurrentChat(userMessage);
                renderMessage(userMessage);
                updateChatTitle(userMessage);
                input.value = '';

                // Show typing indicator
                showTypingIndicator();

                // Get AI response with mode-specific context
                let response;
                if (currentMode === 'simulation' && currentScenario) {
                    scenarioStep++;
                    if (currentChatId && chats[currentChatId]) {
                        chats[currentChatId].scenarioStep = scenarioStep;
                        saveChatHistory();
                    }
                    response = await getSimulationResponse(message);
                } else {
                    response = await getAIResponse(message, currentMode);
                }
                
                removeTypingIndicator();

                const botMessage = {
                    id: Date.now() + 1,
                    text: response,
                    isUser: false,
                    timestamp: new Date()
                };

                addMessageToCurrentChat(botMessage);
                renderMessage(botMessage);

            } catch (error) {
                console.error('Error sending message:', error);
                removeTypingIndicator();

                // Show error message
                const errorMessage = {
                    id: Date.now() + 1,
                    text: 'Sorry, I encountered an error. Please try again.',
                    isUser: false,
                    timestamp: new Date()
                };

                addMessageToCurrentChat(errorMessage);
                renderMessage(errorMessage);
            }
        }

        function addMessageToCurrentChat(message) {
            if (currentChatId && chats[currentChatId]) {
                chats[currentChatId].messages.push(message);
                saveChatHistory();
            }
        }

        function renderMessage(message) {
            const container = document.getElementById('messagesContainer');     
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.isUser ? 'user' : 'bot'}`;

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // Check if the message contains scene markers
            let text = message.text;
            if (text.includes('[SCENE]') || text.includes('[WHAT DO YOU DO?]')) {
                text = text.replace(/\[SCENE\]/g, '<strong>[SCENE]</strong>');
                text = text.replace(/\[WHAT DO YOU DO?\]/g, '<strong>What do you do?</strong>');
            }
            
            bubble.innerHTML = text;

            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = formatTime(message.timestamp);

            messageDiv.appendChild(bubble);
            messageDiv.appendChild(timestamp);
            container.appendChild(messageDiv);
            
            // Scroll to bottom
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messagesContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.id = 'typing-indicator';

            const bubble = document.createElement('div');
            bubble.className = 'bubble typing-indicator';
            bubble.innerHTML = `
                <div class="typing-dots">
                    <span>‚óè</span><span>‚óè</span><span>‚óè</span>
                </div>
            `;

            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            
            // Scroll to bottom
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Enhanced AI Integration with Mode Support
        async function getAIResponse(query, mode = null) {
            try {
                // Get conversation context
                const historyContext = getConversationContext();

                // Build base prompt
                let prompt = AI_RULES
                    .replace('{historyContext}', historyContext)
                    .replace('{userMessage}', query);

                // Add mode-specific instructions if in a mode
                if (mode && MODE_INSTRUCTIONS[mode]) {
                    const modeInstruction = MODE_INSTRUCTIONS[mode];
                    prompt = modeInstruction + '\n\n' + prompt;
                }

                const response = await fetch(`https://autopost-backend-hbck.onrender.com/clearwordsapi/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                     },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();

                let cleaned = data.data.replace(/```json|```/g, '').trim();
                parsed = JSON.parse(cleaned);
                
                return cleanResponse(parsed);

            } catch (error) {
                console.error('Error calling AI API:', error);
                throw error;
            }
        }

        async function getSimulationResponse(query) {
            try {
                // Get conversation context
                const historyContext = getConversationContext();
                
                // Build simulation-specific prompt
                const scenario = SCENARIOS.find(s => s.id === currentScenario);
                const scenarioName = scenario ? scenario.title : currentScenario;
                
                let prompt = MODE_INSTRUCTIONS.simulation
                    .replace('{scenario}', scenarioName)
                    .replace('{step}', scenarioStep) + '\n\n';
                    
                prompt += `Previous interaction context:\n${historyContext}\n\n`;
                prompt += `User's current choice/action: ${query}\n\n`;
                prompt += `Provide the next part of the simulation. If this seems like a natural ending point, wrap up the scenario. Otherwise, continue with the next step and provide new choices.`;

                const response = await fetch(`https://autopost-backend-hbck.onrender.com/clearwordsapi/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                
                // For simulation, we want raw response (not JSON parsed)
                return cleanResponse(data.data);

            } catch (error) {
                console.error('Error calling AI for simulation:', error);
                throw error;
            }
        }

        function cleanResponse(text) {
            // Handle both JSON-parsed objects and raw strings
            if (typeof text !== "string") {
                text2 = `${text.paragraph1} <br><br> ${text.paragraph2} <br><br> ${text.paragraph3}`;
                return text2;
            }
            
            // Remove markdown formatting, asterisks, etc.
            let cleaned = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Convert bold to HTML
                .replace(/\*(.*?)\*/g, '<em>$1</em>')           // Convert italics to HTML
                .replace(/#+\s?/g, '')                         // Remove headers
                .replace(/```[\s\S]*?```/g, '')                // Remove code blocks
                .replace(/`(.*?)`/g, '<code>$1</code>')       // Convert inline code
                .replace(/\n\s*\n/g, '<br><br>')              // Convert double newlines to breaks
                .replace(/```json|```/g, '')  
                .replace(/\n/g, '<br>');                      // Convert single newlines to breaks

            return cleaned;
        }

        // UI Functions
        function toggleTheme() {
            const body = document.body;
            isDarkTheme = !isDarkTheme;

            if (isDarkTheme) {
                body.classList.remove('light-theme');
                body.classList.add('dark-theme');
            } else {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
            }

            updateThemeStatus();
            saveChatHistory();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');

            if(sidebar.classList.toggle) {
                document.getElementById("chatContainer").addEventListener('click', function(e) {
                    closeSidebar();
                });
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('open');
        }

        // PWA Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>