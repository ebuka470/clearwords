<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ClearWords - Learn Nigerian Languages through interactive games and AI conversation">
    <meta name="theme-color" content="#2E8B57">
        <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ClearWords">
    <link rel="apple-touch-icon" href="/logo.png">
    
    <!-- For Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ClearWords">
    
    <!-- For Windows -->
    <meta name="msapplication-TileColor" content="#2E8B57">
    <meta name="msapplication-TileImage" content="/logo.png">
    <meta name="theme-color" content="#2E8B57">

    <link rel="icon" href="logo.png">
    <title>ClearWords - Learn Nigerian Languages</title>
    <link rel="stylesheet" href="app.css">
    <style>
        /* Critical above-the-fold styles only (unchanged) */
        :root {
            /* Light theme */
            --primary-light: #2E8B57;
            --accent1-light: #4169E1;
            --accent2-light: #FF7F50;
            --accent3-light: #FFD700;
            --bg-light: #FFFFFF;
            --card-bg-light: #FFFFFF;
            --text-light: #000000;
            --text-secondary-light: #666666;
            --border-light: #E0E0E0;
            --shadow-light: rgba(0, 0, 0, 0.1);
            
            /* Dark theme - Enhanced for accessibility */
            --primary-dark: #4CAF50;
            --accent1-dark: #2196F3;
            --accent2-dark: #FF9800;
            --accent3-dark: #FFEB3B;
            --bg-dark: #121212;
            --card-bg-dark: #1E1E1E;
            --text-dark: #FFFFFF;
            --text-secondary-dark: #B0B0B0;
            --border-dark: #424242;
            --shadow-dark: rgba(0, 0, 0, 0.3);
            
            /* Current theme variables */
            --primary: var(--primary-light);
            --accent1: var(--accent1-light);
            --accent2: var(--accent2-light);
            --accent3: var(--accent3-light);
            --bg: var(--bg-light);
            --card-bg: var(--card-bg-light);
            --text: var(--text-light);
            --text-secondary: var(--text-secondary-light);
            --border: var(--border-light);
            --shadow: var(--shadow-light);
        }

        .dark-theme {
            --primary: var(--primary-dark);
            --accent1: var(--accent1-dark);
            --accent2: var(--accent2-dark);
            --accent3: var(--accent3-dark);
            --bg: var(--bg-dark);
            --card-bg: var(--card-bg-dark);
            --text: var(--text-dark);
            --text-secondary: var(--text-secondary-dark);
            --border: var(--border-dark);
            --shadow: var(--shadow-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent1);
            outline-offset: 2px;
        }

        /* Loading screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent1-light) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s;
        }

        .loading-logo {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .loading-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 14px;
            opacity: 0.9;
            max-width: 300px;
            text-align: center;
        }

        /* App container */
        #app {
            display: none;
            height: 100vh;
            position: relative;
        }

        /* Onboarding */
        #onboarding {
            display: none;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg);
            color: var(--text);
        }

        /* Page container */
        .page {
            display: none;
            height: calc(100vh - 70px);
            overflow-y: auto;
            padding-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page.active {
            display: block;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px var(--shadow);
            z-index: 100;
            border-top: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 0;
            min-height: 44px;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab .icon {
            font-size: 22px;
            margin-bottom: 4px;
            transition: transform 0.2s;
        }

        .tab.active .icon {
            transform: scale(1.1);
        }

        .tab .label {
            font-weight: 500;
            transition: font-weight 0.2s;
        }

        .tab.active .label {
            font-weight: 600;
        }

        .tab-badge {
            position: absolute;
            top: 5px;
            right: calc(50% - 15px);
            background: var(--accent2);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            font-weight: 600;
        }

        /* Page header */
        .page-header {
            padding: 20px 15px 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent1) 100%);
            color: white;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.1) 100%);
            pointer-events: none;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .page-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Common components */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--accent1);
        }

        .btn-accent {
            background: var(--accent2);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent1));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Onboarding styles */
        .onboarding-step {
            display: none;
            padding: 20px;
            text-align: center;
        }

        .onboarding-step.active {
            display: block;
        }

        .step-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .step-description {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 18px;
            margin: 10px 0;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
            text-align: left;
        }

        .language-option:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .language-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--accent1-rgb), 0.1) 100%);
        }

        .language-emoji {
            font-size: 32px;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .language-name {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .language-stats {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .segment-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 20px;
            margin: 10px 0;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 120px;
        }

        .segment-option:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .segment-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--accent1-rgb), 0.1) 100%);
        }

        .segment-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .segment-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .segment-description {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.4;
        }

        /* Lessons grid */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            padding: 15px;
        }

        .level-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            padding: 15px;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent1));
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .level-card:hover::before {
            transform: translateY(0);
        }

        .level-card.completed {
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.15) 0%, rgba(var(--accent1-rgb), 0.15) 100%);
            border-color: var(--primary);
        }

        .level-card.unlocked {
            background: var(--card-bg);
            border-color: var(--accent1);
        }

        .level-card.unlocked:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .level-card.locked {
            background: var(--bg);
            border-color: var(--border);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .level-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .level-card.completed .level-number {
            color: var(--accent1);
        }

        .level-title {
            font-size: 12px;
            text-align: center;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .level-status {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
        }

        /* Search and filter */
        .search-container {
            padding: 0 15px 15px;
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg);
        }

        .search-input {
            width: 100%;
            padding: 14px 20px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 16px;
            color: var(--text);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .filter-btn {
            padding: 10px 16px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Chat interface */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            max-height:16%;
            z-index: 10;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            margin-left: 12px;
        }

        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }

        .message {
            margin: 20px 0;
            display: flex;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 90%;
            padding: 14px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
        }

        .user .bubble {
            background: linear-gradient(135deg, var(--accent1), var(--primary));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot .bubble {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            position: absolute;
            bottom: 70px;
            left: 0;
            width: 100%;
            padding: 15px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 16px;
            color: var(--text);
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Lesson flow */
        .lesson-flow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .lesson-flow.active {
            display: block;
        }

        .lesson-card {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 80px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow);
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            max-height: calc(100vh - 90px);
        }

        .lesson-card.active {
            transform: translateX(0);
            opacity: 1;
        }

        .lesson-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .lesson-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            padding: 0 20px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .progress-dot.active {
            background: var(--primary);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: var(--accent2);
        }

        /* Test questions */
        .question {
            margin: 24px 0;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
            line-height: 1.4;
        }

        .option {
            padding: 16px 20px;
            margin: 12px 0;
            background: var(--bg);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
        }

        .option:hover {
            background: var(--card-bg);
            border-color: var(--border);
            transform: translateX(4px);
        }

        .option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--accent1-rgb), 0.1) 100%);
        }

        .option.correct {
            border-color: #4CAF50;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.2) 100%);
        }

        .option.incorrect {
            border-color: #F44336;
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.2) 100%);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            font-size: 20px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg);
            color: var(--text);
        }

        .modal-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Search in modals */
        .search-modal-input {
            width: 100%;
            padding: 14px 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 16px;
            color: var(--text);
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .search-modal-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        /* Warning modal */
        .warning-modal {
            max-width: 400px;
        }

        .warning-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent2);
        }

        .warning-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
            text-align: center;
        }

        .warning-text {
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* Confirmation options */
        .confirmation-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .confirmation-option {
            padding: 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirmation-option:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .confirmation-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--accent1-rgb), 0.1) 100%);
        }

        .option-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }

        .option-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Privacy policy content */
        .privacy-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
        }

        .privacy-content h3 {
            margin: 24px 0 12px 0;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        .privacy-content h3:first-child {
            margin-top: 0;
        }

        .privacy-content p {
            margin-bottom: 16px;
        }

        .privacy-content ul {
            padding-left: 24px;
            margin: 12px 0;
        }

        .privacy-content li {
            margin-bottom: 8px;
            position: relative;
        }

        .privacy-content li::before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: -15px;
        }

        /* Segment preview */
        .segment-preview {
            padding: 20px;
            background: var(--bg);
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .preview-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Timmy AI Specific Styles */
        .timmy-message {
            position: relative;
            padding-left: 50px;
        }

        .timmy-message::before {
            content: "ü§ì";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }

        .typing-indicator {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }

        .typing-dots {
            display: inline-block;
            margin-right: 10px;
        }

        .typing-dots span {
            animation: typing 1.4s infinite;
            display: inline-block;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        /* Nigerian slang highlight */
        .nigerian-slang {
            color: var(--accent2);
            font-style: italic;
            font-weight: 600;
        }

        /* Cultural tip highlight */
        .cultural-tip {
            background: linear-gradient(135deg, rgba(var(--accent3-rgb), 0.1) 0%, rgba(var(--primary-rgb), 0.1) 100%);
            border-left: 3px solid var(--accent3);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page {
                padding-bottom: 10px;
            }
            
            .card {
                margin: 10px;
                padding: 16px;
            }
            
            .level-grid {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
                gap: 10px;
                padding: 10px;
            }
            
            .lesson-card {
                top: 5px;
                left: 5px;
                right: 5px;
                bottom: 70px;
                padding: 15px;
                border-radius: 14px;
            }
            
            .lesson-nav {
                height: 65px;
                padding: 0 15px;
            }
            
            .chat-input-container {
                bottom: 65px;
                padding: 12px 15px;
            }
            
            .chat-input {
                padding: 14px 16px;
                font-size: 15px;
            }
            
            .send-btn {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }
            
            .level-card {
                padding: 12px;
            }
            
            .level-number {
                font-size: 24px;
            }
            
            .level-title {
                font-size: 11px;
            }

            .modal {
                max-height: 85vh;
                border-radius: 16px;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-footer {
                padding: 16px 20px;
            }

            .tab .label {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .level-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .page-header {
                padding: 15px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .bottom-nav {
                height: 65px;
            }
            
            .tab .icon {
                font-size: 20px;
                margin-bottom: 3px;
            }
            
            .modal-overlay {
                padding: 10px;
            }

            .segment-option {
                padding: 20px 16px;
                min-height: 100px;
            }

            .segment-icon {
                font-size: 32px;
            }

            .language-option {
                padding: 16px;
                min-height: 56px;
            }

            .language-emoji {
                font-size: 28px;
                margin-right: 16px;
            }
        }

        @media (max-width: 320px) {
            .level-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tab .label {
                font-size: 9px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
                min-height: 44px;
            }
        }

        /* Accessibility: Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print styles */
        @media print {
            .bottom-nav,
            .chat-input-container,
            .lesson-nav,
            .modal-overlay,
            .btn {
                display: none !important;
            }
            
            .page {
                height: auto;
                overflow: visible;
                display: block !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body class="light-theme">
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loading-logo">üó£Ô∏è</div>
        <div class="loading-text">ClearWords</div>
        <div class="loading-subtext">Loading your Nigerian language journey...</div>
        <div class="progress-bar" style="width: 200px; margin-top: 30px;">
            <div class="progress-fill" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Onboarding Container -->
    <div id="onboarding">
        <!-- Step 1: Welcome -->
        <div class="onboarding-step active" id="step1">
            <div style="padding: 40px 20px;">
                <div class="step-title">Welcome to ClearWords</div>
                <div class="step-description">Learn Nigerian languages through interactive games and AI conversation</div>
                <div style="margin: 40px 0; font-size: 48px; animation: pulse 2s infinite;">üó£Ô∏è</div>
                <button class="btn" onclick="nextStep()" style="width: 200px;" aria-label="Get started with ClearWords">
                    Get Started
                </button>
            </div>
        </div>
        
        <!-- Step 2: Segment Selection -->
        <div class="onboarding-step" id="step2">
            <div style="padding: 40px 20px;">
                <div class="step-title">Who are you?</div>
                <div class="step-description">Choose the option that best describes you</div>
                
                <div class="segment-option" onclick="selectSegment('parent', event)" role="button" tabindex="0" aria-label="Diaspora Parent - Teaching my children our heritage language">
                    <div class="segment-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="segment-title">Diaspora Parent</div>
                    <div class="segment-description">Teaching my children our heritage language</div>
                </div>
                
                <div class="segment-option" onclick="selectSegment('young', event)" role="button" tabindex="0" aria-label="Young Diaspora - Connecting with my roots and culture">
                    <div class="segment-icon">üåü</div>
                    <div class="segment-title">Young Diaspora</div>
                    <div class="segment-description">Connecting with my roots and culture</div>
                </div>
                
                <div class="segment-option" onclick="selectSegment('pro', event)" role="button" tabindex="0" aria-label="Professional - Learning for business or career growth">
                    <div class="segment-icon">üíº</div>
                    <div class="segment-title">Professional</div>
                    <div class="segment-description">Learning for business or career growth</div>
                </div>
                
                <div class="segment-option" onclick="selectSegment('marriage', event)" role="button" tabindex="0" aria-label="Marriage/Family - Connecting with partner's Nigerian family">
                    <div class="segment-icon">üíï</div>
                    <div class="segment-title">Marriage/Family</div>
                    <div class="segment-description">Connecting with partner's Nigerian family</div>
                </div>
                
                <div class="segment-option" onclick="selectSegment('nigeria', event)" role="button" tabindex="0" aria-label="In-Nigeria Learner - Learning another Nigerian language">
                    <div class="segment-icon">üá≥üá¨</div>
                    <div class="segment-title">In-Nigeria Learner</div>
                    <div class="segment-description">Learning another Nigerian language</div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="prevStep()" style="background: var(--border);">Back</button>
                    <button class="btn" onclick="nextStep()" id="step2-next" disabled>Continue</button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Language Selection -->
        <div class="onboarding-step" id="step3">
            <div style="padding: 40px 20px;">
                <div class="step-title">Choose a Language</div>
                <div class="step-description">Pick one language to start learning</div>
                
                <div class="language-option" onclick="selectLanguage('yoruba', event)" role="button" tabindex="0" aria-label="Yoruba - 44 million+ speakers">
                    <div class="language-emoji">üëë</div>
                    <div class="language-name">Yoruba</div>
                    <div class="language-stats">44M+ speakers</div>
                </div>
                
                <div class="language-option" onclick="selectLanguage('hausa', event)" role="button" tabindex="0" aria-label="Hausa - 50 million+ speakers">
                    <div class="language-emoji">üïå</div>
                    <div class="language-name">Hausa</div>
                    <div class="language-stats">50M+ speakers</div>
                </div>
                
                <div class="language-option" onclick="selectLanguage('igbo', event)" role="button" tabindex="0" aria-label="Igbo - 34 million+ speakers">
                    <div class="language-emoji">üåç</div>
                    <div class="language-name">Igbo</div>
                    <div class="language-stats">34M+ speakers</div>
                </div>
                
                <div class="language-option" onclick="selectLanguage('urhobo', event)" role="button" tabindex="0" aria-label="Urhobo - 2 million+ speakers">
                    <div class="language-emoji">‚öì</div>
                    <div class="language-name">Urhobo</div>
                    <div class="language-stats">2M+ speakers</div>
                </div>
                
                <div class="language-option" onclick="selectLanguage('itsekiri', event)" role="button" tabindex="0" aria-label="Itsekiri - 1 million+ speakers">
                    <div class="language-emoji">‚öñÔ∏è</div>
                    <div class="language-name">Itsekiri</div>
                    <div class="language-stats">1M+ speakers</div>
                </div>
                
                <!-- NEW: Nigerian Pidgin language option -->
                <div class="language-option" onclick="selectLanguage('pidgin', event)" role="button" tabindex="0" aria-label="Pidgin - 75 million+ speakers">
                    <div class="language-emoji">üó£Ô∏è</div>
                    <div class="language-name">Pidgin</div>
                    <div class="language-stats">75M+ speakers</div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="prevStep()" style="background: var(--border);">Back</button>
                    <button class="btn" onclick="completeOnboarding()" id="step3-next" disabled>Start Learning</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Home Page -->
        <div class="page active" id="home">
            <div class="page-header">
                <div class="page-title" id="home-title">Loading...</div>
                <div class="page-subtitle" id="home-subtitle"></div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Today's Progress</div>
                        <div style="font-size: 24px; font-weight: 700;" id="daily-progress">0/5</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: var(--text-secondary);">üî• Streak</div>
                        <div style="font-size: 24px; font-weight: 700;" id="streak-count">0</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="daily-progress-bar" style="width: 0%;"></div>
                </div>
            </div>
            
            <div class="card">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Continue Learning</div>
                <div id="continue-lesson"></div>
            </div>
            
            <div class="card">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Daily Challenge</div>
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üéØ</div>
                    <div style="margin-bottom: 15px; color: var(--text-secondary);">Complete 3 lessons in 10 minutes</div>
                    <button class="btn" onclick="startSpeedRound()">Start Speed Round</button>
                </div>
            </div>
        </div>
        
        <!-- Lessons Page -->
        <div class="page" id="lessons">
            <div class="page-header">
                <div class="page-title" id="lessons-title">Lessons</div>
                <div class="page-subtitle" id="lessons-subtitle"></div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="lesson-search" placeholder="Search lessons..." oninput="searchLessons()">
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterLevels('all')">All</button>
                    <button class="filter-btn" onclick="filterLevels('completed')">Completed</button>
                    <button class="filter-btn" onclick="filterLevels('unlocked')">Unlocked</button>
                    <button class="filter-btn" onclick="filterLevels('locked')">Locked</button>
                    <button class="filter-btn" onclick="filterLevels('favorites')">Favorites</button>
                </div>
            </div>
            
            <div class="level-grid" id="levels-container">
                <!-- Levels will be dynamically generated here -->
            </div>
        </div>
        
        <!-- Chat Page -->
        <div class="page" id="chat">
            <div class="chat-header">
                <div style="font-size: 24px;">ü§ì</div>
                <div class="chat-title">Timmy - Your AI Language Companion</div>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button class="btn" style="padding: 8px 12px; font-size: 12px;" onclick="clearChat()">Clear</button>
                    <button class="btn" style="padding: 8px 12px; font-size: 12px;" onclick="exportChat()">Export</button>
                </div>
            </div>
            
            <div class="chat-container" id="chat-messages">
                <!-- Chat messages will appear here -->
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask Timmy about Nigerian languages, culture, or practice conversation..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendChatMessage()" aria-label="Send message">‚û§</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div class="page" id="settings">
            <div class="page-header">
                <div class="page-title">Settings</div>
                <div class="page-subtitle">Manage your learning experience</div>
            </div>
            
            <div class="card">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Profile</div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Learning Segment</div>
                    <div style="font-size: 16px; font-weight: 600;" id="current-segment">Not set</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Current Language</div>
                    <div style="font-size: 16px; font-weight: 600;" id="current-language">Not set</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Total XP Earned</div>
                    <div style="font-size: 16px; font-weight: 600;" id="total-xp">0 XP</div>
                </div>
            </div>
            
            <div class="card">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Appearance</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="toggleTheme()" role="button" tabindex="0">
                    <div>Theme</div>
                    <div id="theme-toggle">üåì Light Mode</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="checkPWAStatus()" role="button" tabindex="0">
                  <div>PWA Status</div>
                   <div id="pwa-status">Checking...</div>
            </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="showSegmentSelector()" role="button" tabindex="0">
                    <div>Change Learning Style</div>
                    <div>‚Üí</div>
                </div>
            </div>
            
            <div class="card">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Learning</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="showLanguageSelector()" role="button" tabindex="0">
                    <div>Switch Language</div>
                    <div>‚Üí</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="showTimmyInfo()" role="button" tabindex="0">
                    <div>Meet Timmy (AI)</div>
                    <div>ü§ì</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="exportProgress()" role="button" tabindex="0">
                    <div>Export Progress</div>
                    <div>üì§</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="importProgress()" role="button" tabindex="0">
                    <div>Import Progress</div>
                    <div>üì•</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #FFF5F5; border-radius: 10px; cursor: pointer;" onclick="showResetModal()" role="button" tabindex="0">
                    <div style="color: #F44336;">Reset Progress</div>
                    <div style="color: #F44336;">‚Üí</div>
                </div>
            </div>
            
            <div class="card">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">About</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="showPrivacyPolicy()" role="button" tabindex="0">
                    <div>Privacy Policy</div>
                    <div>‚Üí</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="showTermsOfService()" role="button" tabindex="0">
                    <div>Terms of Service</div>
                    <div>‚Üí</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 10px; cursor: pointer;" onclick="showAbout()" role="button" tabindex="0">
                    <div>About ClearWords</div>
                    <div>‚Üí</div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 15px;">
                <button class="btn btn-outline" onclick="showOnboardingAgain()">Restart Onboarding</button>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav" aria-label="Main navigation">
            <button class="tab active" data-page="home" aria-label="Home">
                <span class="icon">üè†</span>
                <span class="label" id="home-label">Home</span>
            </button>
            <button class="tab" data-page="lessons" aria-label="Lessons">
                <span class="icon">üìö</span>
                <span class="label" id="lessons-label">Lessons</span>
                <span class="tab-badge" id="lessons-badge" style="display: none;"></span>
            </button>
            <button class="tab" data-page="chat" aria-label="AI Tutor">
                <span class="icon">ü§ì</span>
                <span class="label" id="chat-label">Timmy AI</span>
            </button>
            <button class="tab" data-page="settings" aria-label="Settings">
                <span class="icon">‚öôÔ∏è</span>
                <span class="label" id="settings-label">Settings</span>
            </button>
        </nav>
        
        <!-- Lesson Flow Overlay -->
        <div class="lesson-flow" id="lesson-flow">
            <div class="lesson-progress" id="lesson-progress"></div>
            
            <div class="lesson-card active" id="lesson-card-1"></div>
            <div class="lesson-card" id="lesson-card-2"></div>
            <div class="lesson-card" id="lesson-card-3"></div>
            <div class="lesson-card" id="lesson-card-4"></div>
            
            <div class="lesson-nav">
                <button class="btn" onclick="prevLessonCard()" id="prev-btn" style="background: var(--border); color: var(--text);">‚Üê Back</button>
                <div style="font-size: 14px; color: var(--text-secondary);" id="card-counter">1/4</div>
                <button class="btn" onclick="nextLessonCard()" id="next-btn">Next ‚Üí</button>
            </div>
        </div>

        <!-- Enhanced Modals -->
        
        <!-- Privacy Policy Modal -->
        <div class="modal-overlay" id="privacy-modal">
            <div class="modal">
                <div class="modal-header">
                    <div>Privacy Policy</div>
                    <button class="modal-close" onclick="closeModal('privacy-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content privacy-content" id="privacy-content">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('privacy-modal')">Close</button>
                    <button class="btn" onclick="printPrivacyPolicy()">Print</button>
                </div>
            </div>
        </div>

        <!-- Language Switch Modal -->
        <div class="modal-overlay" id="language-modal">
            <div class="modal">
                <div class="modal-header">
                    <div>Switch Language</div>
                    <button class="modal-close" onclick="closeModal('language-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content">
                    <input type="text" class="search-modal-input" id="language-search" placeholder="Search languages..." oninput="filterLanguages()">
                    
                    <div id="language-options">
                        <!-- Languages loaded dynamically -->
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 10px;">
                        <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">
                            <strong>Note:</strong> Switching languages will preserve your progress in your current language. You can switch back anytime.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('language-modal')">Cancel</button>
                    <button class="btn" onclick="confirmLanguageSwitch()" id="confirm-language-btn" disabled>Switch Language</button>
                </div>
            </div>
        </div>

        <!-- Language Switch Warning Modal -->
        <div class="modal-overlay" id="language-warning-modal">
            <div class="modal warning-modal">
                <div class="modal-header">
                    <div>Switch Language</div>
                    <button class="modal-close" onclick="closeModal('language-warning-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-title">Progress Reset Warning</div>
                    <div class="warning-text">
                        Switching to a new language will reset your lesson progress for the current language. 
                        Your profile data and settings will be preserved.
                    </div>
                    
                    <div class="confirmation-options">
                        <div class="confirmation-option" onclick="selectSwitchOption('reset', event)">
                            <div class="option-title">Reset Progress</div>
                            <div class="option-description">Start fresh with the new language</div>
                        </div>
                        <div class="confirmation-option" onclick="selectSwitchOption('preserve', event)">
                            <div class="option-title">Preserve Progress</div>
                            <div class="option-description">Keep current progress separate</div>
                        </div>
                        <div class="confirmation-option" onclick="selectSwitchOption('duplicate', event)">
                            <div class="option-title">Duplicate Profile</div>
                            <div class="option-description">Create a new profile for this language</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('language-warning-modal')">Cancel</button>
                    <button class="btn" onclick="proceedWithLanguageSwitch()" id="proceed-language-btn" disabled>Continue</button>
                </div>
            </div>
        </div>

        <!-- Segment Switch Modal -->
        <div class="modal-overlay" id="segment-modal">
            <div class="modal">
                <div class="modal-header">
                    <div>Change Learning Style</div>
                    <button class="modal-close" onclick="closeModal('segment-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content">
                    <div style="margin-bottom: 20px; color: var(--text-secondary);">
                        Select your learning style to customize content and recommendations:
                    </div>
                    
                    <div id="segment-options">
                        <!-- Segments loaded dynamically -->
                    </div>
                    
                    <div id="segment-preview" class="segment-preview" style="display: none;">
                        <div class="preview-title" id="preview-title"></div>
                        <div class="preview-content" id="preview-content"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('segment-modal')">Cancel</button>
                    <button class="btn" onclick="confirmSegmentSwitch()" id="confirm-segment-btn" disabled>Apply Changes</button>
                </div>
            </div>
        </div>

        <!-- Reset Progress Modal -->
        <div class="modal-overlay" id="reset-modal">
            <div class="modal warning-modal">
                <div class="modal-header">
                    <div>Reset Progress</div>
                    <button class="modal-close" onclick="closeModal('reset-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content">
                    <div class="warning-icon">üóëÔ∏è</div>
                    <div class="warning-title">Reset All Progress</div>
                    <div class="warning-text">
                        This will permanently delete all your learning progress, including completed lessons, XP, and streak. 
                        This action cannot be undone.
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #FFF5F5; border-radius: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="checkbox" id="reset-confirm" style="margin-right: 10px;">
                            <label for="reset-confirm" style="color: #F44336; font-weight: 600;">
                                I understand this action cannot be undone
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('reset-modal')">Cancel</button>
                    <button class="btn" style="background: #F44336;" onclick="resetProgress()" id="reset-btn" disabled>Reset Progress</button>
                </div>
            </div>
        </div>

        <!-- Terms of Service Modal -->
        <div class="modal-overlay" id="terms-modal">
            <div class="modal">
                <div class="modal-header">
                    <div>Terms of Service</div>
                    <button class="modal-close" onclick="closeModal('terms-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content privacy-content" id="terms-content">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('terms-modal')">Close</button>
                </div>
            </div>
        </div>

        <!-- About Modal -->
        <div class="modal-overlay" id="about-modal">
            <div class="modal">
                <div class="modal-header">
                    <div>About ClearWords</div>
                    <button class="modal-close" onclick="closeModal('about-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üó£Ô∏è</div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">ClearWords</div>
                        <div style="color: var(--text-secondary);">Learn Nigerian Languages</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">Version</div>
                        <div style="color: var(--text-secondary);">1.0.0</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">Mission</div>
                        <div style="color: var(--text-secondary); line-height: 1.6;">
                            To make Nigerian language learning accessible, engaging, and effective for everyone, 
                            from diaspora communities to language enthusiasts worldwide.
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">Features</div>
                        <ul style="color: var(--text-secondary); padding-left: 20px; line-height: 1.6;">
                            <li>Comprehensive 50-level curriculum for 6 languages</li>
                            <li>AI-powered language tutor</li>
                            <li>Interactive games and exercises</li>
                            <li>Cultural context and notes</li>
                            <li>Progress tracking and achievements</li>
                            <li>Offline learning support</li>
                        </ul>
                    </div>
                    
                    <div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Contact</div>
                        <div style="color: var(--text-secondary); line-height: 1.6;">
                            For support or feedback: support@clearwords.app
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('about-modal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Progress Import/Export Modal -->
        <div class="modal-overlay" id="progress-modal">
            <div class="modal">
                <div class="modal-header">
                    <div id="progress-modal-title"></div>
                    <button class="modal-close" onclick="closeModal('progress-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content" id="progress-modal-content">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer" id="progress-modal-footer">
                    <!-- Buttons loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Timmy AI Modal -->
        <div class="modal-overlay" id="timmy-modal">
            <div class="modal">
                <div id="timmy-modal-content"></div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // APP INITIALIZATION
        // ======================
        
        console.log("ClearWords app loading...");
        
        // Segment-specific configurations
        const segmentConfigs = {
            parent: {
                name: "Diaspora Parent",
                homeLabel: "Home",
                lessonsLabel: "Lessons",
                chatLabel: "Timmy AI",
                settingsLabel: "Settings",
                description: "Teaching my children our heritage language",
                preview: "Content focuses on family vocabulary, children's activities, and intergenerational communication. Lessons include parent-child dialogues and cultural traditions.",
                colors: {
                    primary: "#2E8B57",
                    accent1: "#4169E1",
                    accent2: "#FF7F50",
                    accent3: "#FFD700"
                }
            },
            young: {
                name: "Young Diaspora",
                homeLabel: "Feed",
                lessonsLabel: "Play",
                chatLabel: "Timmy AI",
                settingsLabel: "Profile",
                description: "Connecting with my roots and culture",
                preview: "Modern, engaging content with social media integration, youth culture, and contemporary vocabulary. Includes music, movies, and current events.",
                colors: {
                    primary: "#4169E1",
                    accent1: "#FF7F50",
                    accent2: "#FFD700",
                    accent3: "#2E8B57"
                }
            },
            pro: {
                name: "Professional",
                homeLabel: "Dashboard",
                lessonsLabel: "Training",
                chatLabel: "Timmy AI",
                settingsLabel: "Settings",
                description: "Learning for business or career growth",
                preview: "Business vocabulary, formal communication, workplace scenarios, and professional etiquette. Focus on meetings, negotiations, and email correspondence.",
                colors: {
                    primary: "#343A40",
                    accent1: "#2E8B57",
                    accent2: "#4169E1",
                    accent3: "#FFD700"
                }
            },
            marriage: {
                name: "Marriage/Family",
                homeLabel: "Home",
                lessonsLabel: "Practice",
                chatLabel: "Timmy AI",
                settingsLabel: "Settings",
                description: "Connecting with partner's Nigerian family",
                preview: "Family relationships, cultural traditions, celebrations, and relationship vocabulary. Focus on in-law communication and cultural integration.",
                colors: {
                    primary: "#FF7F50",
                    accent1: "#2E8B57",
                    accent2: "#4169E1",
                    accent3: "#FFD700"
                }
            },
            nigeria: {
                name: "In-Nigeria Learner",
                homeLabel: "Home",
                lessonsLabel: "Lessons",
                chatLabel: "Timmy AI",
                settingsLabel: "Settings",
                description: "Learning another Nigerian language",
                preview: "Advanced vocabulary, regional dialects, and cultural nuances. Focus on language comparison and advanced grammar structures.",
                colors: {
                    primary: "#2E8B57",
                    accent1: "#4169E1",
                    accent2: "#FF7F50",
                    accent3: "#FFD700"
                }
            }
        };

        // Language configurations (UPDATED: added Nigerian Pidgin)
        const languageConfigs = {
            yoruba: {
                name: "Yoruba",
                nativeName: "Yor√πb√°",
                emoji: "üëë",
                speakers: "44M+",
                greeting: "·∫∏ k√°√†b·ªç",
                jsonFile: "data/yoruba.json",
                levels: 50,
                color: "#2E8B57"
            },
            hausa: {
                name: "Hausa",
                nativeName: "Hausa",
                emoji: "üïå",
                speakers: "50M+",
                greeting: "Sannu",
                jsonFile: "data/hausa.json",
                levels: 50,
                color: "#4169E1"
            },
            igbo: {
                name: "Igbo",
                nativeName: "Igbo",
                emoji: "üåç",
                speakers: "34M+",
                greeting: "Nn·ªç·ªç",
                jsonFile: "data/igbo.json",
                levels: 50,
                color: "#FF7F50"
            },
            urhobo: {
                name: "Urhobo",
                nativeName: "Urhobo",
                emoji: "‚öì",
                speakers: "2M+",
                greeting: "Mavo",
                jsonFile: "data/urhobo.json",
                levels: 50,
                color: "#2196F3"
            },
            itsekiri: {
                name: "Itsekiri",
                nativeName: "Itsekiri",
                emoji: "‚öñÔ∏è",
                speakers: "1M+",
                greeting: "Wel·ªç",
                jsonFile: "data/itsekiri.json",
                levels: 50,
                color: "#FFD700"
            },
            // NEW: Nigerian Pidgin
            pidgin: {
                name: "Pidgin",
                nativeName: "Naija Pidgin",
                emoji: "üó£Ô∏è",
                speakers: "75M+",
                greeting: "How far?",
                jsonFile: "data/pidgin.json",
                levels: 50,
                color: "#8A2BE2"
            }
        };

        // ======================
        // TIMMY AI CONFIGURATION
        // ======================

        // Timmy AI Character Configuration
        const TIMMY_AI_CONFIG = {
            name: "Timmy",
            personality: "witty, culturally-savvy Nigerian language companion",
            style: "Blends academic expertise with street-smart humor and Nigerian pop-culture references",
            tone: "Warm sarcasm that never shames, celebrations that feel like family praise",
            endpoint: "https://autopost-backend-hbck.onrender.com/clearwordsapi/generate"
        };

        // Timmy AI System Prompt with Language Learning Focus
        const TIMMY_AI_RULES = `You are Timmy, a witty, culturally-savvy Nigerian language companion‚Äîthe cool cousin who studied linguistics abroad but came home because he missed proper jollof rice.

ABOUT YOU:
- You blend academic expertise with street-smart humor
- You switch seamlessly between explaining grammar rules and dropping relatable Nigerian pop-culture references
- You use warm sarcasm that never shames and celebrations that feel like family praise
- You make learning feel like chatting with your smartest, funniest friend who genuinely believes in your potential
- You adapt to each learner's segment with appropriate tone and content

STUDENT CONTEXT:
- Learning Segment: {segment}
- Current Language: {language}
- Native Name: {nativeName}
- Completed Levels: {completedLevels}/50
- Current Level: {currentLevel}

RESPONSE FORMAT: Always respond as JSON with exactly three paragraphs:
{
  "paragraph1": "First paragraph with greeting/witty opening",
  "paragraph2": "Second paragraph with main lesson/explanation",
  "paragraph3": "Third paragraph with encouragement/cultural tip"
}

CONVERSATION HISTORY (last 5 messages for context):
{historyContext}

CURRENT USER MESSAGE:
{userMessage}

NOW RESPOND AS TIMMY: Keep it conversational, educational, and entertaining. Mix Nigerian slang with proper language instruction. Never be boring!`;

        // ======================
        // GLOBAL STATE
        // ======================
        
        let appState = {
            user: {
                id: null,
                segment: null,
                language: null,
                completedLevels: [],
                currentLevel: 1,
                streak: 0,
                totalXP: 0,
                dailyGoal: 5,
                dailyCompleted: 0,
                lastActive: null,
                createdAt: null,
                favorites: [],
                progress: {}
            },
            currentPage: 'home',
            currentLesson: null,
            lessonCardIndex: 0,
            testAnswers: [],
            isDarkTheme: false,
            chatHistory: [],
            currentLessonData: null,
            curriculumData: {},
            filteredLevels: 'all',
            searchQuery: '',
            languageToSwitch: null,
            switchOption: null,
            segmentToSwitch: null
        };

        // ======================
        // ONBOARDING VARIABLES
        // ======================
        
        let currentStep = 1;
        let selectedSegment = null;
        let selectedLanguage = null;

        // ======================
        // INITIALIZATION
        // ======================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, starting app...");
            
            // Generate user ID if not exists
            if (!localStorage.getItem('clearWordsUserId')) {
                localStorage.setItem('clearWordsUserId', 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
            }
            
            // Start loading animation
            simulateLoading();
            
            // Check for saved state
            setTimeout(() => {
                loadAppState();
            }, 1500);
        });

        function simulateLoading() {
            const progressFill = document.querySelector('.progress-fill');
            let width = 0;
            const interval = setInterval(() => {
                width += 5;
                progressFill.style.width = width + '%';
                if (width >= 100) {
                    clearInterval(interval);
                }
            }, 50);
        }

        function loadAppState() {
            const savedState = localStorage.getItem('clearWordsState');
            const userId = localStorage.getItem('clearWordsUserId');
            
            if (savedState && userId) {
                try {
                    const parsed = JSON.parse(savedState);
                    if (parsed.user && parsed.user.segment && parsed.user.language) {
                        console.log("Loading saved state...");
                        appState = parsed;
                        
                        // Check if state belongs to current user
                        if (parsed.user.id === userId) {
                            showMainApp();
                            return;
                        }
                    }
                } catch (e) {
                    console.error("Error loading saved state:", e);
                }
            }
            
            // Show onboarding
            console.log("Showing onboarding...");
            showOnboarding();
        }

        function showOnboarding() {
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('onboarding').style.display = 'block';
                
                // Initialize step 1
                currentStep = 1;
                selectedSegment = null;
                selectedLanguage = null;
                document.getElementById('step1').classList.add('active');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.remove('active');
            }, 500);
        }

        function showMainApp() {
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                initializeApp();
            }, 500);
        }

        // ======================
        // ONBOARDING FUNCTIONS
        // ======================
        
        function nextStep() {
            if (currentStep === 1) {
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                currentStep = 2;
            } else if (currentStep === 2 && selectedSegment) {
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.add('active');
                currentStep = 3;
            }
        }

        function prevStep() {
            if (currentStep === 2) {
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1').classList.add('active');
                currentStep = 1;
            } else if (currentStep === 3) {
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                currentStep = 2;
            }
        }

        function selectSegment(segment, event) {
            selectedSegment = segment;
            document.querySelectorAll('#step2 .segment-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            document.getElementById('step2-next').disabled = false;
        }

        function selectLanguage(language, event) {
            selectedLanguage = language;
            document.querySelectorAll('#step3 .language-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            document.getElementById('step3-next').disabled = false;
        }

        function completeOnboarding() {
            if (!selectedSegment || !selectedLanguage) {
                alert('Please select both a segment and a language.');
                return;
            }
            
            // Generate new user ID
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('clearWordsUserId', userId);
            
            // Initialize app state
            appState = {
                user: {
                    id: userId,
                    segment: selectedSegment,
                    language: selectedLanguage,
                    completedLevels: [],
                    currentLevel: 1,
                    streak: 0,
                    totalXP: 0,
                    dailyGoal: 5,
                    dailyCompleted: 0,
                    lastActive: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString(),
                    favorites: [],
                    progress: {}
                },
                currentPage: 'home',
                currentLesson: null,
                lessonCardIndex: 0,
                testAnswers: [],
                isDarkTheme: false,
                chatHistory: [],
                currentLessonData: null,
                curriculumData: {},
                filteredLevels: 'all',
                searchQuery: '',
                languageToSwitch: null,
                switchOption: null,
                segmentToSwitch: null
            };
            
            saveState();
            
            // Load curriculum for selected language
            loadCurriculum(selectedLanguage, () => {
                // Hide onboarding and show app
                document.getElementById('onboarding').style.display = 'none';
                initializeApp();
                document.getElementById('app').style.display = 'block';
            });
        }

        function showOnboardingAgain() {
            if (confirm("Are you sure you want to restart onboarding? Your current progress will be saved.")) {
                document.getElementById('app').style.display = 'none';
                document.getElementById('onboarding').style.display = 'block';
                document.getElementById('step1').classList.add('active');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.remove('active');
                currentStep = 1;
                selectedSegment = null;
                selectedLanguage = null;
            }
        }

        // ======================
        // APP FUNCTIONS
        // ======================
        
        function initializeApp() {
            console.log("initializeApp called");
            
            // Apply segment theme
            applySegmentTheme();
            
            // Apply theme from state
            if (appState.isDarkTheme) {
                document.body.classList.add('dark-theme');
                document.getElementById('theme-toggle').textContent = 'üåì Dark Mode';
            }
            
            // Load curriculum if not loaded
            if (!appState.curriculumData[appState.user.language]) {
                loadCurriculum(appState.user.language);
            }
            
            // Update UI with user data
            updateUserUI();
            
            // Load levels
            generateLevels();
            
            // Setup navigation
            setupNavigation();
            
            // Setup chat with Timmy
            setupChat();
            
            // Check daily streak
            checkDailyStreak();
            
            // Load privacy policy
            loadPrivacyPolicy();
            
            // Load terms of service
            loadTermsOfService();
            
            // Load Timmy modal
            loadTimmyModal();
            
            // Show current page
            showPage('home');
        }

        function checkPWAStatus() {
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const statusEl = document.getElementById('pwa-status');
    
    if (isPWA) {
        statusEl.innerHTML = '‚úÖ Installed';
        statusEl.style.color = 'var(--primary)';
        showToast('ClearWords is running as a standalone app! üéâ');
    } else if (window.deferredPrompt) {
        statusEl.innerHTML = 'üì± Available';
        statusEl.style.color = 'var(--accent2)';
        if (window.showInstallPrompt) {
            showInstallPrompt();
        }
    } else {
        statusEl.innerHTML = 'üåê Browser';
        statusEl.style.color = 'var(--text-secondary)';
        showToast('Installation prompt will appear when available.');
    }
}

// Initialize PWA status check on settings page load
document.addEventListener('DOMContentLoaded', function() {
    // This will run after the main app loads
    setTimeout(() => {
        const pwaStatusEl = document.getElementById('pwa-status');
        if (pwaStatusEl) {
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            if (isPWA) {
                pwaStatusEl.innerHTML = '‚úÖ Installed';
                pwaStatusEl.style.color = 'var(--primary)';
            } else if (window.deferredPrompt) {
                pwaStatusEl.innerHTML = 'üì± Available';
                pwaStatusEl.style.color = 'var(--accent2)';
            } else {
                pwaStatusEl.innerHTML = 'üåê Browser';
                pwaStatusEl.style.color = 'var(--text-secondary)';
            }
        }
    }, 1000);
});

        function applySegmentTheme() {
            const segment = appState.user.segment;
            if (!segment || !segmentConfigs[segment]) return;
            
            const config = segmentConfigs[segment];
            
            // Update navigation labels
            document.getElementById('home-label').textContent = config.homeLabel;
            document.getElementById('lessons-label').textContent = config.lessonsLabel;
            document.getElementById('chat-label').textContent = config.chatLabel;
            document.getElementById('settings-label').textContent = config.settingsLabel;
        }

        function updateUserUI() {
            const user = appState.user;
            const segment = segmentConfigs[user.segment]?.name || 'Not set';
            const language = languageConfigs[user.language]?.name || 'Not set';
            
            // Update home page
            document.getElementById('home-title').textContent = `Learning ${language}`;
            document.getElementById('home-subtitle').textContent = `${segment} | Day ${user.streak}`;
            document.getElementById('streak-count').textContent = user.streak;
            document.getElementById('daily-progress').textContent = `${user.dailyCompleted}/${user.dailyGoal}`;
            
            // Update lessons page
            document.getElementById('lessons-title').textContent = `${language} Lessons`;
            document.getElementById('lessons-subtitle').textContent = `${user.completedLevels.length}/50 levels completed`;
            
            // Update settings page
            document.getElementById('current-segment').textContent = segment;
            document.getElementById('current-language').textContent = language;
            document.getElementById('total-xp').textContent = `${user.totalXP} XP`;
            
            // Update progress bar
            const progress = (user.dailyCompleted / user.dailyGoal) * 100;
            document.getElementById('daily-progress-bar').style.width = `${progress}%`;
            
            // Update continue lesson
            updateHomeContent();
            
            // Update lessons badge
            updateLessonsBadge();
        }

        function updateLessonsBadge() {
            const badge = document.getElementById('lessons-badge');
            if (appState.user.currentLevel > appState.user.completedLevels.length + 1) {
                badge.textContent = '!';
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // ======================
        // CURRICULUM LOADING
        // ======================
        
        function loadCurriculum(language, callback = null) {
            const languageConfig = languageConfigs[language];
            if (!languageConfig) {
                console.error("Language config not found:", language);
                if (callback) callback();
                return;
            }
            
            console.log(`Loading curriculum for ${language}...`);
            
            // Check if already loaded
            if (appState.curriculumData[language]) {
                console.log("Curriculum already loaded");
                if (callback) callback();
                return;
            }
            
            // Load from JSON file
            fetch(languageConfig.jsonFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load ${languageConfig.jsonFile}: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Successfully loaded ${language} curriculum with ${data.levels?.length || 0} levels`);
                    appState.curriculumData[language] = data;
                    
                    // Generate levels if on lessons page
                    if (appState.user.language === language) {
                        generateLevels();
                    }
                    
                    if (callback) callback();
                })
                .catch(error => {
                    console.error("Error loading curriculum:", error);
                    
                    // Create NEW custom fallback curriculum (50-level exact specification)
                    createFallbackCurriculum(language);
                    
                    if (callback) callback();
                });
        }

        // ======================
        // NEW CUSTOM FALLBACK CURRICULUM (50-level exact specification)
        // ======================
        
        function createFallbackCurriculum(language) {
            const langConfig = languageConfigs[language] || languageConfigs.yoruba;
            const greeting = langConfig.greeting;
            const languageName = langConfig.name;
            
            // ----- Block 1: The Survival Shell (Levels 1‚Äì10) -----
            const block1 = [
                { level: 1,  topic: "Greetings",   synopsis: "Learn the specific greetings for Morning, Afternoon, and Evening (E kaaro, E kaasan, E ku irole). Cultural focus: Why you must greet before asking for anything." },
                { level: 2,  topic: "Expressions",   synopsis: "Asking about well-being, responding 'Hello', 'How are you?', 'Where are you from?', 'What is your name?'" },
                { level: 3,  topic: "Introduction",      synopsis: "Introducing yourself." },
                { level: 4,  topic: "Empathy",     synopsis: "The non-apology 'Sorry': 'Mbem', 'Ndo'. Differentiate from 'Forgive me.'" },
                { level: 5,  topic: "Basic Needs",     synopsis: "Asking for basic necessities and identifying them." },
                { level: 6,  topic: "Food",        synopsis: "Ordering street food (Yam and Egg, Boli, Suya). Key phrases: 'I want small small,' 'Add pepper,' 'Pack for me take away.'" },
                { level: 7,  topic: "Directions",  synopsis: "Asking for directions: 'Where is...' and understanding 'Straight,' 'Turn at the big mango tree,' 'It is facing the road.'" },
                { level: 8,  topic: "Haggling",    synopsis: "Market negotiations: 'Reduce it for me,' 'Last price?' 'Na you be the boss.' 'How much?'" },
                { level: 9,  topic: "Exiting",        synopsis: "Polite disengagement: 'I am in a hurry,' 'Let me go small,' 'I will come back.'" },
                { level: 10, topic: "Test 1",      synopsis: "Assessment: Simulated scenario ‚Äì bump into a neighbour, greet, ask about family, apologise for noise, say goodbye." }
            ];
            
            // ----- Block 2: Daily Rhythms (Levels 11‚Äì20) -----
            const block2 = [
                { level: 11, topic: "Home",      synopsis: "Vocabulary for the Nigerian household: Verandah, Parlour, 'Go and bring the kettle.'" },
                { level: 12, topic: "Family",    synopsis: "Specific terms for 'My mother‚Äôs sibling' vs. 'Father‚Äôs sibling.' Grandparents, Siblings. Cultural focus: Why you cannot date someone you call 'Sister.'" },
                { level: 13, topic: "Body",      synopsis: "Parts of the body ‚Äì practical usage: 'My head is spinning' (illness), 'Open your mouth' (at the clinic)." },
                { level: 14, topic: "Colours",   synopsis: "Describing clothing: 'I am wearing blue,' Ankara, George wrapper. Cultural focus: Colour symbolism in weddings/funerals." },
                { level: 15, topic: "Morning Routine",   synopsis: "Morning routine ‚Äì simple past tense: 'I bathed,' 'I ate,' 'I left the house.'" },
                { level: 16, topic: "Scenarios", synopsis: "Unique Nigerian situations: 'The light has gone' (power outage), 'Stop here!' (Okada), 'Hold your change.'" },
                { level: 17, topic: "Work",      synopsis: "Professions, especially informal economy: 'I sell clothes,' 'I run a canteen,' 'I am a student.'" },
                { level: 18, topic: "Time",      synopsis: "Nigerian time concepts: 'Now now' (immediate), 'Small time' (soon), 'Morning' (anytime before noon). Confirming appointments." },
                { level: 19, topic: "Weather",   synopsis: "Harmattan, Rainy season, Dry season. 'The sun is hot today,' 'I am cold.' Weather as social lubricant." },
                { level: 20, topic: "Test 2",    synopsis: "Assessment: Tell a story about your day ‚Äì waking up, leaving, a problem you solved, and returning home." }
            ];
            
            // ----- Block 3: Relationships & Emotions (Levels 21‚Äì30) -----
            const block3 = [
                { level: 21, topic: "Health",         synopsis: "Asking after someone‚Äôs health: 'How is your body?' 'I am tired,' 'I am coughing.' Empathy: 'Sorry for the pain.'" },
                { level: 22, topic: "Questions",      synopsis: "Answering personal questions ('Are you married?' 'How many children?' 'Why are you not fat?'). Polite deflections and humour." },
                { level: 23, topic: "Preferences",    synopsis: "Expressing likes/dislikes: 'I love this,' 'I hate pepper,' 'I don‚Äôt like wahala.'" },
                { level: 24, topic: "Gossip",         synopsis: "Small talk vocabulary: 'Did you hear?' 'Who told you?' 'Keep it between us.' Etiquette of secret‚Äëkeeping." },
                { level: 25, topic: "Mood",           synopsis: "Emotions: happiness, anger, sadness, confusion. 'I am annoyed,' 'Don‚Äôt worry me,' 'I am just laughing.'" },
                { level: 26, topic: "Invitation",     synopsis: "Inviting to parties, weddings, burials. Stating location, date, and the phrase 'Your presence is requested.'" },
                { level: 27, topic: "Accept/Decline", synopsis: "Saying 'Yes' enthusiastically. Saying 'No' without burning bridges: 'I will try,' 'God willing,' 'I am not around.'" },
                { level: 28, topic: "Compliments",    synopsis: "'You look beautiful,' 'You are shining!' 'I love your fit.' Cultural note: avoid praising babies/objects without 'God bless.'" },
                { level: 29, topic: "Condolences",    synopsis: "High‚Äëstakes phrases: 'Be strong,' 'It is well,' 'Long life to you.'" },
                { level: 30, topic: "Test 3",         synopsis: "Assessment: Role‚Äëplay ‚Äì a friend is sad. Ask what‚Äôs wrong, listen, and offer appropriate comfort." }
            ];
            
            // ----- Block 4: The Wider World (Levels 31‚Äì40) -----
            const block4 = [
                { level: 31, topic: "Travel",      synopsis: "Shared taxi / bus: 'Driver, drop me at the junction,' 'Let me enter,' 'I am going to the main market.'" },
                { level: 32, topic: "Mechanic",    synopsis: "Basic car issues: 'The tyre is flat,' 'It is making noise,' 'How long will it take?'" },
                { level: 33, topic: "Pharmacy",    synopsis: "Symptoms: 'I have a fever,' 'I am vomiting,' 'Do you have something for malaria?'" },
                { level: 34, topic: "Now",         synopsis: "Present continuous: 'They are dancing,' 'It is raining,' 'The food is burning!'" },
                { level: 35, topic: "Weekend",     synopsis: "Past events: 'I went to the village,' 'We attended a naming ceremony.'" },
                { level: 36, topic: "Future",      synopsis: "'I will call you,' 'I will pay you on Friday,' 'We shall get there.' Cultural weight of promises." },
                { level: 37, topic: "Instructions", synopsis: "'Cut it small small,' 'Add water gradually,' 'Turn it off.'" },
                { level: 38, topic: "Advice",      synopsis: "'Don‚Äôt touch that,' 'Be careful,' 'If I were you...'" },
                { level: 39, topic: "Formal",      synopsis: "Code‚Äëswitching: speaking 'High' Nigerian English / formal vernacular in professional settings." },
                { level: 40, topic: "Test 4",      synopsis: "Assessment: You are helping a foreign visitor navigate Lagos/Abuja/Kano ‚Äì give directions, negotiate a price, and order lunch." }
            ];
            
            // ----- Block 5: Fluency & Cultural Mastery (Levels 41‚Äì50) -----
            const block5 = [
                { level: 41, topic: "Proverbs",    synopsis: "'A child who washes his hands...' and 'The sun that shines...' ‚Äì context, not just memorisation." },
                { level: 42, topic: "Complaint",   synopsis: "Express dissatisfaction without shouting: 'This thing is not correct,' 'I paid for service but...' Assertive, not aggressive." },
                { level: 43, topic: "Slang",       synopsis: "Current youth slang: 'Ajebo,' 'Omo,' 'Gbese,' 'Jaiye.' Warning: when not to use these." },
                { level: 44, topic: "Humor",       synopsis: "Simple jokes, wordplay, and how to laugh at yourself." },
                { level: 45, topic: "Celebration", synopsis: "Vocabulary for weddings, birthdays, title‚Äëtaking: 'I bring lafun,' 'Join the spray,' 'Mama, dance!'" },
                { level: 46, topic: "Tradition",   synopsis: "Explaining cultural norms: 'In the past we did X, but now we do Y.'" },
                { level: 47, topic: "Phone",       synopsis: "Bad networks: 'Hello, can you hear me?' 'Cut the call and call me back,' 'I am on the line.'" },
                { level: 48, topic: "Opinion",     synopsis: "Stating views without starting a fight: 'In my opinion,' 'I beg to differ.'" },
                { level: 49, topic: "Story",       synopsis: "Narrative structure: setting, problem, climax, resolution. 'Let me tell you what happened...'" },
                { level: 50, topic: "Test 5",      synopsis: "Final Assessment: Full, unstructured conversation ‚Äì meet a stranger at an event, introduce yourself, discuss where you‚Äôre from, current affairs, family, joke, and exchange contact info seamlessly." }
            ];
            
            const allLevels = [...block1, ...block2, ...block3, ...block4, ...block5];
            const levels = [];
            
            for (let i = 0; i < allLevels.length; i++) {
                const lvl = allLevels[i];
                const level = lvl.level;
                const topic = lvl.topic;
                const synopsis = lvl.synopsis;
                const isTest = topic.startsWith("Test");
                
                // Difficulty based on level
                let difficulty;
                if (level <= 10) difficulty = "Beginner";
                else if (level <= 20) difficulty = "Elementary";
                else if (level <= 30) difficulty = "Intermediate";
                else if (level <= 40) difficulty = "Upper Intermediate";
                else difficulty = "Advanced";
                
                if (isTest) {
                    // ----- TEST LEVELS -----
                    const testExercises = [];
                    for (let q = 1; q <= 4; q++) {
                        testExercises.push({
                            type: "multipleChoice",
                            question: `Question ${q}: Choose the correct answer for this scenario.`,
                            options: ["Option A", "Option B", "Option C", "Option D"],
                            correctAnswer: 0,
                            explanation: "This is a placeholder question. The real assessment will test your practical skills."
                        });
                    }
                    
                    levels.push({
                        level: level,
                        topic: topic,               // "Test 1", "Test 2", etc.
                        subTopic: topic,
                        title: topic,              // exact title from spec
                        description: synopsis,
                        learningObjectives: [
                            "Demonstrate comprehension",
                            "Apply vocabulary in context",
                            "Navigate real‚Äëlife scenario"
                        ],
                        vocabulary: [],             // no new vocab in tests
                        grammarPoints: [],
                        dialogue: [],
                        culturalNotes: [],          // optional
                        practiceExercises: testExercises,
                        segmentCustomizations: {},
                        tips: [
                            "Take your time",
                            "Read each question carefully",
                            "Review your answers",
                            "You can retry if needed"
                        ],
                        prerequisites: level > 1 ? [`Complete Level ${level-1}`] : [],
                        unlocks: level < 50 ? [`Access to Level ${level+1}`] : ["Certificate of Completion"],
                        estimatedTime: "10-15 minutes",
                        xpReward: 50,
                        difficulty: difficulty,
                        tags: ["test", `level-${level}`]
                    });
                    
                } else {
                    // ----- REGULAR LESSONS -----
                    // Vocabulary: at least one item ‚Äì use the language's greeting for level 1, otherwise placeholder
                    let vocabulary = [];
                    if (level === 1) {
                        vocabulary = [{
                            word: greeting,
                            translation: "Hello",
                            pronunciation: greeting.toLowerCase(),
                            example: `${greeting}, how are you?`,
                            culturalNote: `Basic greeting in ${languageName}`
                        }];
                    } else {
                        vocabulary = [{
                            word: `[${topic} word]`,
                            translation: `Translation of a ${topic} word`,
                            pronunciation: "[pronunciation]",
                            example: `Example sentence with ${topic} word.`,
                            culturalNote: `Cultural context for ${topic}`
                        }];
                    }
                    
                    // Grammar: at least one basic grammar point
                    const grammarPoints = [{
                        concept: "Basic Sentence Structure",
                        explanation: "Subject-Verb-Object order",
                        examples: ["I eat food", "She reads book"],
                        pattern: "S + V + O"
                    }];
                    
                    // Dialogue: two simple lines using greeting
                    const dialogue = [
                        { speaker: "Person A", text: greeting, translation: "Hello", audioContext: "Greeting" },
                        { speaker: "Person B", text: "How are you?", translation: "Response", audioContext: "Response" }
                    ];
                    
                    // Cultural notes: generic but relevant
                    const culturalNotes = [{
                        title: "Cultural Context",
                        content: `Greetings are important in ${languageName} culture.`
                    }];
                    
                    // Practice exercise: one multiple‚Äëchoice question about the greeting
                    const practiceExercises = [{
                        type: "multipleChoice",
                        question: `What is "Hello" in ${languageName}?`,
                        options: [greeting, "Thank you", "Goodbye", "Please"],
                        correctAnswer: 0,
                        explanation: `"${greeting}" is the standard greeting.`
                    }];
                    
                    // Segment customizations ‚Äì generic placeholder tips
                    const segmentCustomizations = {
                        parent: { tips: [`Practice ${topic} with children`] },
                        young: { tips: [`Use ${topic} in social media`] },
                        pro: { tips: [`Business applications of ${topic}`] },
                        marriage: { tips: [`Family conversations about ${topic}`] },
                        nigeria: { tips: [`Regional variations in ${topic}`] }
                    };
                    
                    levels.push({
                        level: level,
                        topic: topic,
                        subTopic: topic,
                        title: `Level ${level}: ${topic}`,
                        description: synopsis,
                        learningObjectives: [
                            `Learn 10 new ${languageName} words related to ${topic}`,
                            "Understand basic grammar concepts",
                            "Practice pronunciation",
                            "Complete exercises"
                        ],
                        vocabulary: vocabulary,
                        grammarPoints: grammarPoints,
                        dialogue: dialogue,
                        culturalNotes: culturalNotes,
                        practiceExercises: practiceExercises,
                        segmentCustomizations: segmentCustomizations,
                        tips: ["Practice daily", "Repeat aloud", "Use in context"],
                        prerequisites: level > 1 ? [`Complete Level ${level-1}`] : [],
                        unlocks: level < 50 ? [`Access to Level ${level+1}`] : ["Certificate of Completion"],
                        estimatedTime: "15-20 minutes",
                        xpReward: 25,
                        difficulty: difficulty,
                        tags: [topic.toLowerCase(), `level-${level}`]
                    });
                }
            }
            
            // Build the final curriculum object
            const fallbackCurriculum = {
                language: language,
                name: languageName,
                levels: levels
            };
            
            appState.curriculumData[language] = fallbackCurriculum;
            console.log(`Created new 50-level custom fallback curriculum for ${languageName} (${language})`);
        }

        // ======================
        // LEVELS MANAGEMENT
        // ======================
        
        function generateLevels() {
            const container = document.getElementById('levels-container');
            if (!container) {
                console.error("Levels container not found!");
                return;
            }
            
            container.innerHTML = '';
            
            const language = appState.user.language;
            const curriculum = appState.curriculumData[language];
            const completedLevels = appState.user.completedLevels;
            const currentLevel = appState.user.currentLevel;
            
            if (!curriculum || !curriculum.levels) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìö</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Loading lessons...</div>
                        <div style="color: var(--text-secondary);">Curriculum data is being loaded</div>
                    </div>
                `;
                return;
            }
            
            // Filter levels based on current filter
            let levelsToShow = curriculum.levels;
            
            if (appState.filteredLevels === 'completed') {
                levelsToShow = levelsToShow.filter(level => completedLevels.includes(level.level));
            } else if (appState.filteredLevels === 'unlocked') {
                levelsToShow = levelsToShow.filter(level => level.level <= currentLevel && !completedLevels.includes(level.level));
            } else if (appState.filteredLevels === 'locked') {
                levelsToShow = levelsToShow.filter(level => level.level > currentLevel);
            } else if (appState.filteredLevels === 'favorites') {
                levelsToShow = levelsToShow.filter(level => appState.user.favorites.includes(level.level));
            }
            
            // Apply search filter
            if (appState.searchQuery) {
                const query = appState.searchQuery.toLowerCase();
                levelsToShow = levelsToShow.filter(level => 
                    level.title.toLowerCase().includes(query) ||
                    level.description.toLowerCase().includes(query) ||
                    level.topic.toLowerCase().includes(query) ||
                    (level.subTopic && level.subTopic.toLowerCase().includes(query)) ||
                    (level.tags && level.tags.some(tag => tag.includes(query)))
                );
            }
            
            if (levelsToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">No lessons found</div>
                        <div style="color: var(--text-secondary);">Try changing your filters or search query</div>
                    </div>
                `;
                return;
            }
            
            // Generate level cards
            levelsToShow.forEach(levelData => {
                const level = levelData.level;
                const levelDiv = document.createElement('div');
                levelDiv.className = 'level-card';
                
                // Determine level status
                if (completedLevels.includes(level)) {
                    levelDiv.classList.add('completed');
                    levelDiv.innerHTML = `
                        <div class="level-status">‚úÖ</div>
                        <div class="level-number">${level}</div>
                        <div class="level-title">${levelData.subTopic || levelData.topic}</div>
                    `;
                    levelDiv.onclick = () => reviewLesson(level);
                } else if (level <= currentLevel) {
                    levelDiv.classList.add('unlocked');
                    levelDiv.innerHTML = `
                        <div class="level-status">üîì</div>
                        <div class="level-number">${level}</div>
                        <div class="level-title">${levelData.subTopic || levelData.topic}</div>
                    `;
                    levelDiv.onclick = () => startLesson(level);
                } else {
                    levelDiv.classList.add('locked');
                    levelDiv.innerHTML = `
                        <div class="level-status">üîí</div>
                        <div class="level-number">${level}</div>
                        <div class="level-title">${levelData.subTopic || levelData.topic}</div>
                    `;
                }
                
                // Add favorite indicator
                if (appState.user.favorites.includes(level)) {
                    const favoriteStar = document.createElement('div');
                    favoriteStar.style.position = 'absolute';
                    favoriteStar.style.top = '5px';
                    favoriteStar.style.left = '5px';
                    favoriteStar.style.fontSize = '12px';
                    favoriteStar.style.color = 'var(--accent3)';
                    favoriteStar.textContent = '‚≠ê';
                    levelDiv.appendChild(favoriteStar);
                }
                
                container.appendChild(levelDiv);
            });
        }

        function filterLevels(filter) {
            appState.filteredLevels = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            generateLevels();
        }

        function searchLessons() {
            const searchInput = document.getElementById('lesson-search');
            appState.searchQuery = searchInput.value.trim();
            generateLevels();
        }

        // ======================
        // LESSON FLOW FUNCTIONS
        // ======================
        
        function startLesson(level) {
            console.log("Starting lesson:", level);
            appState.currentLesson = level;
            appState.lessonCardIndex = 0;
            appState.testAnswers = [];
            
            // Load lesson data
            loadLessonData(level);
            
            // Show lesson flow
            document.getElementById('lesson-flow').classList.add('active');
            
            // Show first card
            showLessonCard(0);
        }

        function reviewLesson(level) {
            appState.currentLesson = level;
            appState.lessonCardIndex = 0;
            
            // Load lesson data
            loadLessonData(level);
            
            // Show lesson flow
            document.getElementById('lesson-flow').classList.add('active');
            
            // Show first card
            showLessonCard(0);
        }

        function loadLessonData(level) {
            const language = appState.user.language;
            const curriculum = appState.curriculumData[language];
            
            if (!curriculum || !curriculum.levels) {
                console.error("Curriculum not loaded for:", language);
                // This should never happen because we have fallback, but just in case:
                createFallbackCurriculum(language);
                setTimeout(() => loadLessonData(level), 100);
                return;
            }
            
            const lessonData = curriculum.levels.find(l => l.level === level);
            if (!lessonData) {
                console.error("Lesson not found:", level);
                return;
            }
            
            appState.currentLessonData = lessonData;
            populateLessonCards(lessonData);
        }

        // populateLessonCards and all other lesson flow functions remain EXACTLY as in original
        function populateLessonCards(lessonData) {
            const segment = appState.user.segment;
            const segmentCustom = lessonData.segmentCustomizations?.[segment] || {};
            
            // Card 1: Main Content
            document.getElementById('lesson-card-1').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">LEVEL ${lessonData.level} ‚Ä¢ ${lessonData.topic || 'General'}</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">${lessonData.title}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">${lessonData.description}</div>
                </div>
                
                ${lessonData.learningObjectives ? `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Learning Objectives</div>
                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                            ${lessonData.learningObjectives.map(obj => `<li>${obj}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">New Words & Phrases</div>
                
                ${lessonData.vocabulary.map((word, index) => `
                    <div style="margin-bottom: 15px; padding: 16px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="font-size: 20px; font-weight: 600; color: var(--primary); margin-right: 10px;">${word.word}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); font-style: italic;">${word.pronunciation}</div>
                                </div>
                                <div style="font-size: 14px; color: var(--text); margin-bottom: 8px;">${word.translation}</div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">"${word.example}"</div>
                                ${word.culturalNote ? `<div style="font-size: 12px; color: var(--accent1); font-style: italic;">üí° ${word.culturalNote}</div>` : ''}
                            </div>
                            <button class="btn" style="padding: 8px 12px; font-size: 12px; min-width: 60px;" onclick="playWordAudio('${word.word}', '${lessonData.language || appState.user.language}')">üîä Hear</button>
                        </div>
                    </div>
                `).join('')}
                
                ${segmentCustom.tips ? `
                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--accent1-rgb), 0.1) 100%); border-radius: 12px;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 5px;">üéØ Segment Tip</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">${segmentCustom.tips[0] || ''}</div>
                    </div>
                ` : ''}
            `;
            
            // Card 2: Grammar & Culture
            document.getElementById('lesson-card-2').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">GRAMMAR & CULTURE</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 10px;">Grammar & Cultural Context</div>
                </div>
                
                ${lessonData.grammarPoints && lessonData.grammarPoints.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--accent1);">Grammar Points</div>
                        ${lessonData.grammarPoints.map((grammar, index) => `
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text);">${grammar.concept}</div>
                                <div style="color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5;">${grammar.explanation}</div>
                                ${grammar.pattern ? `<div style="font-size: 12px; color: var(--accent2); margin-bottom: 10px;">Pattern: ${grammar.pattern}</div>` : ''}
                                ${grammar.examples ? `
                                    <div style="margin-top: 10px;">
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Examples:</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            ${grammar.examples.map(ex => `<li>${ex}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${lessonData.culturalNotes && lessonData.culturalNotes.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--accent2);">Cultural Insights</div>
                        ${lessonData.culturalNotes.map((note, index) => `
                            <div style="margin-bottom: 15px; padding: 16px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text);">${note.title}</div>
                                <div style="color: var(--text-secondary); line-height: 1.6;">${note.content}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            // Card 3: Dialogue Practice
            document.getElementById('lesson-card-3').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">CONVERSATION PRACTICE</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 10px;">Dialogue Practice</div>
                </div>
                
                <div style="background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border);">
                    ${lessonData.dialogue.map((line, index) => `
                        <div style="margin-bottom: ${index < lessonData.dialogue.length - 1 ? '15px' : '0'};">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="background: ${line.speaker === 'You' ? 'var(--accent1)' : 'var(--primary)'}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; font-weight: 600;">
                                    ${line.speaker.charAt(0)}
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                                        <div style="font-weight: 600; color: var(--text);">${line.speaker}</div>
                                        ${line.audioContext ? `<button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="playDialogueLine(${index})">üîä</button>` : ''}
                                    </div>
                                    <div style="font-size: 16px; margin-bottom: 3px; color: var(--text);">${line.text}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); font-style: italic;">"${line.translation}"</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="playFullDialogue()" style="flex: 1;">
                        üîä Play Full Dialogue
                    </button>
                    <button class="btn" onclick="practiceWithPartner()" style="flex: 1; background: var(--accent1);">
                        üë• Practice with Partner
                    </button>
                </div>
            `;
            
            // Card 4: Test
            document.getElementById('lesson-card-4').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">KNOWLEDGE CHECK</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">Test Your Understanding</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Score ${Math.ceil((lessonData.practiceExercises?.length || 4) * 0.67)}/${lessonData.practiceExercises?.length || 4} to pass (67%)</div>
                </div>
                
                ${(lessonData.practiceExercises || []).map((exercise, index) => {
                    if (exercise.type === 'multipleChoice') {
                        return `
                            <div class="question" style="margin-bottom: 25px;">
                                <div class="question-text">${index + 1}. ${exercise.question}</div>
                                ${exercise.options.map((opt, optIndex) => `
                                    <div class="option" onclick="selectTestAnswer(${index}, ${optIndex})" data-question="${index}" data-option="${optIndex}">
                                        ${opt}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    return '';
                }).join('')}
                
                ${lessonData.tips ? `
                    <div style="margin-top: 30px; padding: 15px; background: var(--bg); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="font-weight: 600; margin-bottom: 5px; color: var(--text);">üí° Tips:</div>
                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                            ${lessonData.tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        function showLessonCard(index) {
            // Hide all cards
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show selected card
            const cardId = `lesson-card-${index + 1}`;
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.add('active');
            }
            
            appState.lessonCardIndex = index;
            
            // Update progress dots
            updateLessonProgress();
            
            // Update card counter
            document.getElementById('card-counter').textContent = `${index + 1}/4`;
            
            // Update navigation buttons
            updateLessonNavigation();
        }

        function updateLessonProgress() {
            const progressContainer = document.getElementById('lesson-progress');
            if (!progressContainer) return;
            
            progressContainer.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i === appState.lessonCardIndex) {
                    dot.classList.add('active');
                } else if (i < appState.lessonCardIndex) {
                    dot.classList.add('completed');
                }
                progressContainer.appendChild(dot);
            }
        }

        function updateLessonNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn) {
                prevBtn.style.display = appState.lessonCardIndex === 0 ? 'none' : 'block';
            }
            
            if (nextBtn) {
                if (appState.lessonCardIndex === 3) {
                    nextBtn.textContent = 'Submit Test';
                    nextBtn.onclick = submitTest;
                } else {
                    nextBtn.textContent = 'Next ‚Üí';
                    nextBtn.onclick = nextLessonCard;
                }
            }
        }

        function nextLessonCard() {
            if (appState.lessonCardIndex < 3) {
                showLessonCard(appState.lessonCardIndex + 1);
            }
        }

        function prevLessonCard() {
            if (appState.lessonCardIndex > 0) {
                showLessonCard(appState.lessonCardIndex - 1);
            }
        }

        function selectTestAnswer(questionIndex, optionIndex) {
            const question = event.currentTarget.parentElement;
            question.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            appState.testAnswers[questionIndex] = optionIndex;
        }

        function submitTest() {
            const lessonData = appState.currentLessonData;
            const exercises = lessonData.practiceExercises || [];
            
            if (appState.testAnswers.length < exercises.length) {
                alert(`Please answer all ${exercises.length} questions before submitting.`);
                return;
            }
            
            let score = 0;
            exercises.forEach((exercise, index) => {
                if (appState.testAnswers[index] === exercise.correctAnswer) {
                    score++;
                }
            });
            
            const passingScore = Math.ceil(exercises.length * 0.67);
            const passed = score >= passingScore;
            
            if (passed) {
                completeLesson();
            } else {
                showTestResults(false, score, exercises.length);
            }
        }

        function completeLesson() {
            const level = appState.currentLesson;
            
            if (!appState.user.completedLevels.includes(level)) {
                appState.user.completedLevels.push(level);
                appState.user.currentLevel = Math.max(appState.user.currentLevel, level + 1);
                appState.user.totalXP += 25;
                appState.user.dailyCompleted += 1;
                
                updateStreak();
                saveState();
                updateUserUI();
                generateLevels();
            }
            
            showTestResults(true, appState.testAnswers.length, appState.testAnswers.length);
        }

        function showTestResults(passed, score, total) {
            const lessonData = appState.currentLessonData;
            
            document.getElementById('lesson-card-4').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">${passed ? 'üéâ' : 'üìù'}</div>
                    <div style="font-size: 28px; font-weight: 700; color: ${passed ? 'var(--primary)' : '#F44336'}; margin-bottom: 10px;">
                        ${passed ? 'Level Complete!' : 'Needs Practice'}
                    </div>
                    <div style="font-size: 18px; margin-bottom: 20px;">Score: ${score}/${total} correct</div>
                    
                    ${passed ? `
                        <div style="background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div>XP Earned:</div>
                                <div style="font-weight: 600; color: var(--accent3);">+25 XP</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div>Total XP:</div>
                                <div style="font-weight: 600;">${appState.user.totalXP} XP</div>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <div>üî• Streak:</div>
                                <div style="font-weight: 600;">${appState.user.streak} days</div>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="closeLessonFlow()" style="width: 100%; margin-bottom: 15px;">Continue Learning</button>
                        <button class="btn" onclick="practiceWithTimmy()" style="background: var(--accent1); width: 100%;">Practice with Timmy</button>
                    ` : `
                        <div style="background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 1px solid var(--border);">
                            <div style="font-weight: 600; margin-bottom: 10px; color: var(--text);">Review these areas:</div>
                            <ul style="text-align: left; padding-left: 20px; color: var(--text-secondary);">
                                <li>Vocabulary pronunciation</li>
                                <li>Grammar concepts</li>
                                <li>Cultural context</li>
                                <li>Dialogue patterns</li>
                            </ul>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="showLessonCard(0)" style="flex: 1; background: var(--border); color: var(--text);">Review Cards</button>
                            <button class="btn" onclick="retryTest()" style="flex: 1;">Retry Test</button>
                        </div>
                    `}
                </div>
            `;
        }

        function closeLessonFlow() {
            document.getElementById('lesson-flow').classList.remove('active');
            showPage('lessons');
        }

        function retryTest() {
            appState.testAnswers = [];
            showLessonCard(3);
        }

        function practiceWithTimmy() {
            closeLessonFlow();
            showPage('chat');
            
            setTimeout(() => {
                const language = languageConfigs[appState.user.language].name;
                const input = document.getElementById('chat-input');
                if (input) {
                    input.value = `I just completed level ${appState.currentLesson} on ${language}. Can we practice a conversation using what I learned?`;
                    sendChatMessage();
                }
            }, 500);
        }

        function practiceWithPartner() {
            showPage('chat');
            setTimeout(() => {
                const input = document.getElementById('chat-input');
                if (input) {
                    input.value = "Can we practice the dialogue from my current lesson together?";
                    sendChatMessage();
                }
            }, 500);
        }

        // ======================
        // TIMMY AI FUNCTIONS (UPDATED with Pidgin support)
        // ======================

        // Get conversation context from chat history
        function getChatContext() {
            if (!appState.chatHistory || appState.chatHistory.length === 0) {
                return "New conversation just started. Student is beginning their language journey.";
            }
            
            // Get last 5 messages (excluding current one)
            const recentMessages = appState.chatHistory.slice(-5);
            let context = "";
            
            recentMessages.forEach(msg => {
                const speaker = msg.sender === 'user' ? 'Student' : 'Timmy';
                context += `${speaker}: ${msg.text}\n`;
            });
            
            return context;
        }

        // Generate AI response using Timmy's personality
        async function generateTimmyAIResponse(userMessage) {
            try {
                // Get student context
                const segment = segmentConfigs[appState.user.segment]?.name || 'Language Learner';
                const language = languageConfigs[appState.user.language];
                
                // Build the prompt with context
                const prompt = TIMMY_AI_RULES
                    .replace('{segment}', segment)
                    .replace('{language}', language.name)
                    .replace('{nativeName}', language.nativeName || language.name)
                    .replace('{completedLevels}', appState.user.completedLevels.length)
                    .replace('{currentLevel}', appState.user.currentLevel)
                    .replace('{historyContext}', getChatContext())
                    .replace('{userMessage}', userMessage);
                
                // Call AI API
                const response = await fetch(TIMMY_AI_CONFIG.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Parse and format the response
                const cleaned = data.data.replace(/```json|```/g, '').trim();
                const parsed = JSON.parse(cleaned);
                
                // Format for chat display
                const formattedResponse = `
                    <div style="margin-bottom: 10px; font-style: italic; color: var(--accent2);">
                        ü§ì <strong>Timmy says:</strong>
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.6;">
                        ${parsed.paragraph1}
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.6;">
                        ${parsed.paragraph2}
                    </div>
                    <div style="margin-bottom: 10px; line-height: 1.6; color: var(--primary);">
                        ${parsed.paragraph3}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 10px;">
                        üéØ <strong>Timmy's Tip:</strong> Remember, language is best learned with laughter!
                    </div>
                `;
                
                return formattedResponse;
                
            } catch (error) {
                console.error("Timmy AI Error:", error);
                
                // Fallback responses with Timmy's personality (UPDATED: includes Pidgin words)
                const fallbackResponses = [
                    `Abeg, my API dey catch cold! But no worry, Timmy is here! ${languageConfigs[appState.user.language]?.greeting || "Hello"}! Let's continue our lesson.`,
                    `Network wahala! But as your guy Timmy, I go still teach you something small. Today's word: "${getRandomNigerianWord()}"`,
                    `Jazz don happen to my connection, but Timmy no dey carry last! How about we practice some ${languageConfigs[appState.user.language]?.name || "Nigerian"} phrases?`,
                    `Even when technology fails, culture prevails! ${languageConfigs[appState.user.language]?.greeting || "Hello"} my friend, let's continue learning!`
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                
                return `
                    <div style="margin-bottom: 10px; font-style: italic; color: var(--accent2);">
                        ü§ì <strong>Timmy says:</strong>
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.6;">
                        ${randomResponse}
                    </div>
                    <div style="margin-bottom: 10px; line-height: 1.6; color: var(--primary);">
                        <em>PS: My tech dey act up, but my teaching spirit dey kampe!</em>
                    </div>
                `;
            }
        }

        // Helper function for fallback responses (UPDATED: added Pidgin)
        function getRandomNigerianWord() {
            const words = {
                yoruba: ["·∫∏ k√°√†b·ªç (Welcome)", "O ·π£eun (Thank you)", "·∫∏ k√∫ oj√∫m·ªç (Good morning)"],
                hausa: ["Sannu (Hello)", "Na gode (Thank you)", "Ina kwana? (How are you?)"],
                igbo: ["Nn·ªç·ªç (Welcome)", "Daal·ª• (Thank you)", "Kedu ka ·ªã mere? (How are you?)"],
                urhobo: ["Mavo (Welcome)", "Uvw·∫π (Thank you)", "M·∫π r·∫π? (How are you?)"],
                itsekiri: ["Wel·ªç (Welcome)", "Oshe (Thank you)", "M·∫π re? (How are you?)"],
                pidgin: ["How far? (Hello)", "Abeg (Please)", "Wahala (Trouble)", "Oya (Let's go)"]
            };
            
            const language = appState.user.language;
            const languageWords = words[language] || ["Welcome", "Thank you", "How are you?"];
            return languageWords[Math.floor(Math.random() * languageWords.length)];
        }

        // Segment-specific Timmy greetings (UPDATED: added pidgin case)
        function getTimmyGreeting() {
            const segment = appState.user.segment;
            const language = languageConfigs[appState.user.language];
            
            const greetings = {
                parent: `Omo mi! ${language.greeting}! As your parenting partner Timmy, I'm here to help you pass our beautiful ${language.name} to the next generation. Ready to make learning fun for the whole family?`,
                young: `Wahala for who no sabi! ${language.greeting} G! Timmy dey here to help you connect with your roots in the most lit way. Let's learn ${language.name} like we're chatting on the gram!`,
                pro: `Professional mode activated! ${language.greeting}, sir/ma. Timmy here to provide you with business-ready ${language.name} skills that will give you the edge in the marketplace.`,
                marriage: `Love don show! ${language.greeting}, future in-law! Timmy here to help you impress the family with authentic ${language.name} and cultural savvy. Let's make you the favorite!`,
                nigeria: `Naija to the world! ${language.greeting}, my fellow Naija learner. Timmy here to help you master ${language.name} with all the local flavor and pro tips.`,
                pidgin: `${language.greeting}! Abeg, make we learn Naija Pidgin well well! Timmy here to help you speak like true bonafide Naija person!`,
                default: `${language.greeting}! I'm Timmy, your witty Nigerian language companion. Ready to learn ${language.name} with laughter and cultural insight?`
            };
            
            return greetings[segment] || greetings.default;
        }

        // ======================
        // UPDATED CHAT FUNCTIONS
        // ======================

        // Replace the existing generateAIResponse function
        window.generateAIResponse = async function(userMessage) {
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Get response from Timmy AI
                const response = await generateTimmyAIResponse(userMessage);
                
                // Remove typing indicator
                removeTypingIndicator();
                
                return response;
                
            } catch (error) {
                console.error("Error in AI response:", error);
                removeTypingIndicator();
                
                return `Abeg, Timmy dey rest small! But no worry, I go still help you. ${languageConfigs[appState.user.language]?.greeting || "Hello"}! How can I assist with your ${languageConfigs[appState.user.language]?.name || "language"} learning today?`;
            }
        };

        // Enhanced sendChatMessage with Timmy's personality
        window.sendChatMessage = async function() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Save to state
            appState.chatHistory.push({
                text: message,
                sender: 'user',
                timestamp: new Date().toISOString()
            });
            
            // Get AI response
            try {
                const response = await generateAIResponse(message);
                addChatMessage(response, 'bot');
                
                // Save AI response to state
                appState.chatHistory.push({
                    text: response,
                    sender: 'bot',
                    timestamp: new Date().toISOString()
                });
                
                // Save to localStorage
                localStorage.setItem('clearWordsChat', JSON.stringify(appState.chatHistory));
                
            } catch (error) {
                console.error("Chat error:", error);
                
                const errorMessage = `Abeg, network wahala! Timmy dey try reach you. ${languageConfigs[appState.user.language]?.greeting || "Hello"}! Let's try that again?`;
                addChatMessage(errorMessage, 'bot');
            }
        };

        // Enhanced chat setup with Timmy
        window.setupChat = function() {
            // Load chat history
            const savedChat = localStorage.getItem('clearWordsChat');
            if (savedChat) {
                try {
                    appState.chatHistory = JSON.parse(savedChat);
                } catch (e) {
                    appState.chatHistory = [];
                }
            }
            
            // Render chat history with Timmy's welcome
            renderChatHistory();
        };

        // Updated renderChatHistory with Timmy's personality
        window.renderChatHistory = function() {
            const chatContainer = document.getElementById('chat-messages');
            if (!chatContainer) return;
            
            chatContainer.innerHTML = '';
            
            // Add Timmy's personalized welcome message
            const welcomeMessage = getTimmyGreeting();
            addChatMessage(welcomeMessage, 'bot');
            
            // Load history
            appState.chatHistory.forEach(msg => {
                addChatMessage(msg.text, msg.sender);
            });
        };

        // Typing indicator functions
        window.showTypingIndicator = function() {
            const chatContainer = document.getElementById('chat-messages');
            if (!chatContainer) return;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble typing-indicator';
            bubble.innerHTML = `
                <div class="typing-dots">
                    <span>‚óè</span><span>‚óè</span><span>‚óè</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Timmy is typing...
                </div>
            `;
            
            typingDiv.appendChild(bubble);
            chatContainer.appendChild(typingDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        window.removeTypingIndicator = function() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        };

        // Add chat message helper
        window.addChatMessage = function(text, sender) {
            const chatContainer = document.getElementById('chat-messages');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = text;
            
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Practice with Timmy function (after lesson completion)
        window.practiceWithTimmy = async function() {
            showPage('chat');
            
            const language = languageConfigs[appState.user.language].name;
            const level = appState.currentLesson || 1;
            
            // Clear any existing typing indicator
            removeTypingIndicator();
            
            // Add user message
            const userMessage = `I just completed level ${level} on ${language}. Can we practice what I learned?`;
            addChatMessage(userMessage, 'user');
            
            // Save to state
            appState.chatHistory.push({
                text: userMessage,
                sender: 'user',
                timestamp: new Date().toISOString()
            });
            
            // Show typing indicator
            showTypingIndicator();
            
            // Get AI response
            try {
                const response = await generateAIResponse(userMessage);
                removeTypingIndicator();
                addChatMessage(response, 'bot');
                
                // Save AI response to state
                appState.chatHistory.push({
                    text: response,
                    sender: 'bot',
                    timestamp: new Date().toISOString()
                });
                
                // Save to localStorage
                localStorage.setItem('clearWordsChat', JSON.stringify(appState.chatHistory));
                
            } catch (error) {
                console.error("Practice error:", error);
                removeTypingIndicator();
                
                const errorMessage = `Omo! Technical difficulty, but no shaking. Let's practice ${language} anyway!`;
                addChatMessage(errorMessage, 'bot');
            }
        };

        // ======================
        // NEW CHAT FUNCTIONS
        // ======================

        // Clear chat with Timmy's personality
        window.clearChat = function() {
            if (confirm("Abeg, you wan clear all our yarn? Make we start fresh?")) {
                appState.chatHistory = [];
                localStorage.setItem('clearWordsChat', JSON.stringify([]));
                renderChatHistory();
                
                // Add Timmy's fresh start message
                setTimeout(() => {
                    addChatMessage("Fresh start, fresh energy! Timmy dey here with you. Wetin you wan learn today?", 'bot');
                }, 300);
            }
        };

        // Export chat with custom filename
        window.exportChat = function() {
            const exportData = {
                exportDate: new Date().toISOString(),
                student: {
                    segment: appState.user.segment,
                    language: appState.user.language,
                    completedLevels: appState.user.completedLevels.length,
                    totalXP: appState.user.totalXP
                },
                chatHistory: appState.chatHistory,
                aiCompanion: "Timmy - Your witty Nigerian language companion"
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clearwords-chat-with-timmy-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            // Show confirmation
            showToast("Chat exported! Timmy's wisdom saved for later! üìÅ");
        };

        // Show Timmy's info in settings
        window.showTimmyInfo = function() {
            loadTimmyModalContent();
            showModal('timmy-modal');
        };

        // Load Timmy modal content
        function loadTimmyModal() {
            const timmyModal = document.getElementById('timmy-modal');
            if (timmyModal) {
                const modalContent = document.createElement('div');
                modalContent.id = 'timmy-modal-content';
                timmyModal.querySelector('.modal').appendChild(modalContent);
            }
        }

        function loadTimmyModalContent() {
            const content = document.getElementById('timmy-modal-content');
            if (!content) return;
            
            content.innerHTML = `
                <div class="modal-header">
                    <div>Meet Timmy ü§ì</div>
                    <button class="modal-close" onclick="closeModal('timmy-modal')" aria-label="Close">√ó</button>
                </div>
                <div class="modal-content">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ü§ì</div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">Timmy</div>
                        <div style="color: var(--text-secondary);">Your Nigerian Language Companion</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: var(--accent2);">üé≠ Personality</div>
                        <div style="color: var(--text-secondary); line-height: 1.6;">
                            The cool cousin who studied linguistics abroad but came home because he missed proper jollof rice. 
                            Blends academic expertise with street-smart humor and Nigerian pop-culture references.
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: var(--accent2);">üéØ Teaching Style</div>
                        <ul style="color: var(--text-secondary); padding-left: 20px; line-height: 1.6;">
                            <li>Warm sarcasm that never shames</li>
                            <li>Celebrations that feel like family praise</li>
                            <li>Authentic cultural context and pro-tips</li>
                            <li>Adapts to your learning segment</li>
                            <li>Makes mistakes become inside jokes</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: var(--accent2);">üí¨ What to Expect</div>
                        <div style="color: var(--text-secondary); line-height: 1.6;">
                            Timmy will mix proper grammar explanations with Nigerian slang, pop culture references, 
                            and the kind of encouragement that makes you feel like you're chatting with your smartest, 
                            funniest friend who genuinely believes in your potential.
                        </div>
                    </div>
                    
                    <div style="padding: 15px; background: var(--bg); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="font-weight: 600; margin-bottom: 5px; color: var(--primary);">üìö Pro Tip from Timmy:</div>
                        <div style="color: var(--text-secondary);">
                            "Language is best learned with laughter and plenty of jollof rice! No be by force, make we enjoy the process together!"
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('timmy-modal')">Close</button>
                    <button class="btn" onclick="showPage('chat'); closeModal('timmy-modal')">Chat with Timmy</button>
                </div>
            `;
        }

        // ======================
        // MODAL FUNCTIONS (unchanged)
        // ======================
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
            
            // Reset modal states
            if (modalId === 'language-modal') {
                appState.languageToSwitch = null;
                document.getElementById('confirm-language-btn').disabled = true;
            } else if (modalId === 'segment-modal') {
                appState.segmentToSwitch = null;
                document.getElementById('confirm-segment-btn').disabled = true;
                document.getElementById('segment-preview').style.display = 'none';
            } else if (modalId === 'reset-modal') {
                document.getElementById('reset-confirm').checked = false;
                document.getElementById('reset-btn').disabled = true;
            }
        }

        function showPrivacyPolicy() {
            showModal('privacy-modal');
        }

        function loadPrivacyPolicy() {
            const content = document.getElementById('privacy-content');
            if (!content) return;
            
            content.innerHTML = `
                <h3>Privacy Policy</h3>
                <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                
                <h3>1. Information We Collect</h3>
                <p>ClearWords collects the following information to provide and improve our language learning service:</p>
                <ul>
                    <li><strong>Learning Data:</strong> Your progress, completed lessons, test scores, learning preferences, and study patterns</li>
                    <li><strong>Profile Information:</strong> Your selected language, learning segment, streak data, and XP earned</li>
                    <li><strong>Chat History:</strong> Conversations with our AI tutor (stored locally on your device for personalization)</li>
                    <li><strong>Usage Data:</strong> How you interact with the app (lessons completed, time spent, features used)</li>
                    <li><strong>Device Information:</strong> Browser type, operating system, and device identifiers for compatibility</li>
                </ul>
                
                <h3>2. How We Use Your Information</h3>
                <ul>
                    <li>To personalize your learning experience based on your segment and progress</li>
                    <li>To track your progress and provide personalized feedback and recommendations</li>
                    <li>To improve our app, curriculum, and AI tutor through anonymous usage analysis</li>
                    <li>To provide customer support and respond to your inquiries</li>
                    <li>To send important updates about the app (optional)</li>
                    <li>To ensure the security and integrity of our platform</li>
                </ul>
                
                <h3>3. Data Storage & Security</h3>
                <p>All your learning data is stored locally on your device using browser storage (LocalStorage and IndexedDB). We do not transmit your personal learning data to external servers unless you explicitly choose to:</p>
                <ul>
                    <li>Sync your progress across devices (future feature)</li>
                    <li>Backup your data to cloud storage (future feature</li>
                    <li>Share your achievements on social media (optional)</li>
                </ul>
                <p>We implement appropriate technical and organizational security measures to protect your data, including encryption of sensitive information and regular security assessments.</p>
                
                <h3>4. Data Sharing & Third Parties</h3>
                <p>We do not sell, trade, or rent your personal learning data to third parties. We may share anonymous, aggregated data for:</p>
                <ul>
                    <li>Research purposes to improve language learning methodologies</li>
                    <li>Analytics to understand overall app usage patterns</li>
                    <li>Compliance with legal obligations when required by law</li>
                </ul>
                
                <h3>5. Your Rights & Choices</h3>
                <p>You have full control over your data:</p>
                <ul>
                    <li><strong>Access:</strong> View all your stored data through the app's export feature</li>
                    <li><strong>Correction:</strong> Update your profile information anytime</li>
                    <li><strong>Deletion:</strong> Delete all app data by clearing your browser storage or using the reset feature</li>
                    <li><strong>Export:</strong> Export your progress and chat history for backup</li>
                    <li><strong>Opt-out:</strong> Disable specific features or data collection</li>
                </ul>
                
                <h3>6. Children's Privacy</h3>
                <p>ClearWords is designed to be family-friendly and suitable for all ages. We do not knowingly collect personal information from children under 13 without parental consent. Parents can:</p>
                <ul>
                    <li>Monitor their children's progress through shared devices</li>
                    <li>Use the "Diaspora Parent" segment for family learning</li>
                    <li>Contact us to review or delete any children's data</li>
                </ul>
                
                <h3>7. Cookies & Tracking Technologies</h3>
                <p>We use minimal browser storage for essential app functionality:</p>
                <ul>
                    <li>LocalStorage: Saves your progress and preferences</li>
                    <li>SessionStorage: Manages your current learning session</li>
                    <li>Cookies: Only for essential functions like authentication (if implemented)</li>
                </ul>
                <p>We do not use tracking cookies for advertising or cross-site tracking.</p>
                
                <h3>8. International Data Transfers</h3>
                <p>Since all data is stored locally on your device, there are no international data transfers. If cloud features are added in the future, data will be transferred only with your explicit consent and using secure protocols.</p>
                
                <h3>9. Data Retention</h3>
                <p>Your data is retained as follows:</p>
                <ul>
                    <li><strong>Active Accounts:</strong> Data is retained indefinitely while you use the app</li>
                    <li><strong>Inactive Accounts:</strong> Data may be deleted after 24 months of inactivity</li>
                    <li><strong>Upon Request:</strong> Data is deleted immediately when you use the reset feature</li>
                </ul>
                
                <h3>10. Changes to This Policy</h3>
                <p>We may update this privacy policy from time to time. We will notify you of any significant changes by:</p>
                <ul>
                    <li>Updating the "Last Updated" date at the top of this policy</li>
                    <li>Displaying a notification in the app for major changes</li>
                    <li>Asking for your consent when required by law</li>
                </ul>
                <p>We encourage you to review this policy periodically.</p>
                
                <h3>11. Contact Us</h3>
                <p>If you have questions, concerns, or requests about this privacy policy or your data:</p>
                <ul>
                    <li>Email: privacy@clearwords.app</li>
                    <li>In-app: Use the chat feature to contact support</li>
                    <li>Mail: ClearWords Privacy Team, Lagos, Nigeria</li>
                </ul>
                <p>We will respond to all inquiries within 30 days.</p>
                
                <h3>12. Compliance & Regulations</h3>
                <p>ClearWords complies with:</p>
                <ul>
                    <li>General Data Protection Regulation (GDPR) for EU users</li>
                    <li>California Consumer Privacy Act (CCPA) for California users</li>
                    <li>Nigerian Data Protection Regulation (NDPR)</li>
                    <li>Children's Online Privacy Protection Act (COPPA)</li>
                </ul>
            `;
        }

        function printPrivacyPolicy() {
            const content = document.getElementById('privacy-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>ClearWords Privacy Policy</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
                        h3 { color: #2E8B57; margin-top: 20px; }
                        ul { padding-left: 20px; }
                        li { margin-bottom: 5px; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function showTermsOfService() {
            showModal('terms-modal');
        }

        function loadTermsOfService() {
            const content = document.getElementById('terms-content');
            if (!content) return;
            
            content.innerHTML = `
                <h3>Terms of Service</h3>
                <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing and using ClearWords, you accept and agree to be bound by these Terms of Service. If you do not agree, please do not use the app.</p>
                
                <h3>2. Description of Service</h3>
                <p>ClearWords provides interactive Nigerian language learning through lessons, exercises, and AI-powered conversation practice. The service includes:</p>
                <ul>
                    <li>50-level curriculum for 6 Nigerian languages</li>
                    <li>AI language tutor for conversation practice</li>
                    <li>Progress tracking and achievements</li>
                    <li>Offline learning capability</li>
                </ul>
                
                <h3>3. User Accounts</h3>
                <p>No account registration is required. Your progress is stored locally on your device. You are responsible for:</p>
                <ul>
                    <li>Backing up your progress using the export feature</li>
                    <li>Keeping your device secure</li>
                    <li>All activities that occur under your local profile</li>
                </ul>
                
                <h3>4. Intellectual Property</h3>
                <p>All content in ClearWords, including lessons, exercises, and curriculum, is protected by copyright and other intellectual property laws. You may:</p>
                <ul>
                    <li>Use the content for personal, non-commercial language learning</li>
                    <li>Share your progress and achievements</li>
                </ul>
                <p>You may not:</p>
                <ul>
                    <li>Copy, distribute, or modify the content for commercial purposes</li>
                    <li>Reverse engineer or attempt to extract the source code</li>
                    <li>Use the content to create a competing service</li>
                </ul>
                
                <h3>5. User Conduct</h3>
                <p>You agree to use ClearWords responsibly and not to:</p>
                <ul>
                    <li>Use the AI tutor for inappropriate content</li>
                    <li>Attempt to hack or compromise the app</li>
                    <li>Share malicious content through the chat feature</li>
                    <li>Use automated systems to access the service</li>
                </ul>
                
                <h3>6. Privacy</h3>
                <p>Your privacy is important. Please review our Privacy Policy to understand how we handle your data.</p>
                
                <h3>7. Disclaimers</h3>
                <p>ClearWords is provided "as is" without warranties of any kind. We do not guarantee:</p>
                <ul>
                    <li>That the app will be error-free or uninterrupted</li>
                    <li>The accuracy of all language content</li>
                    <li>That you will achieve fluency within a specific timeframe</li>
                </ul>
                
                <h3>8. Limitation of Liability</h3>
                <p>ClearWords and its developers shall not be liable for any indirect, incidental, or consequential damages arising from your use of the app.</p>
                
                <h3>9. Changes to Terms</h3>
                <p>We may update these terms. Continued use of the app after changes constitutes acceptance.</p>
                
                <h3>10. Governing Law</h3>
                <p>These terms are governed by the laws of Nigeria.</p>
                
                <h3>11. Contact</h3>
                <p>Questions about these terms? Contact: legal@clearwords.app</p>
            `;
        }

        function showAbout() {
            showModal('about-modal');
        }

        // ======================
        // LANGUAGE SWITCHING (now automatically includes Pidgin)
        // ======================
        
        function showLanguageSelector() {
            const container = document.getElementById('language-options');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.entries(languageConfigs).forEach(([key, config]) => {
                const isCurrent = key === appState.user.language;
                const option = document.createElement('div');
                option.className = `language-option ${isCurrent ? 'selected' : ''}`;
                option.onclick = (e) => selectLanguageInModal(key, e);
                option.innerHTML = `
                    <div class="language-emoji">${config.emoji}</div>
                    <div class="language-name">${config.name}</div>
                    <div class="language-stats">${config.speakers} speakers</div>
                    ${isCurrent ? '<div style="color: var(--primary); font-size: 12px; font-weight: 600;">Current</div>' : ''}
                `;
                container.appendChild(option);
            });
            
            showModal('language-modal');
        }

        function selectLanguageInModal(language, event) {
            if (language === appState.user.language) {
                alert("This is already your current language!");
                return;
            }
            
            appState.languageToSwitch = language;
            
            // Update selection
            document.querySelectorAll('#language-modal .language-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('confirm-language-btn').disabled = false;
        }

        function filterLanguages() {
            const searchInput = document.getElementById('language-search');
            const query = searchInput.value.toLowerCase();
            const options = document.querySelectorAll('#language-modal .language-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        function confirmLanguageSwitch() {
            if (!appState.languageToSwitch) return;
            
            if (appState.user.completedLevels.length > 0 || appState.user.totalXP > 0) {
                // Show warning modal for progress reset
                showModal('language-warning-modal');
            } else {
                // No progress to reset, switch directly
                switchLanguage(appState.languageToSwitch, 'preserve');
            }
        }

        function selectSwitchOption(option, event) {
            appState.switchOption = option;
            
            // Update selection
            document.querySelectorAll('.confirmation-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('proceed-language-btn').disabled = false;
        }

        function proceedWithLanguageSwitch() {
            if (!appState.languageToSwitch || !appState.switchOption) return;
            
            switchLanguage(appState.languageToSwitch, appState.switchOption);
            closeModal('language-warning-modal');
            closeModal('language-modal');
        }

        function switchLanguage(newLanguage, option) {
            const oldLanguage = appState.user.language;
            
            // Save current progress for old language
            if (option === 'preserve' || option === 'duplicate') {
                if (!appState.user.progress[oldLanguage]) {
                    appState.user.progress[oldLanguage] = {};
                }
                appState.user.progress[oldLanguage].completedLevels = [...appState.user.completedLevels];
                appState.user.progress[oldLanguage].currentLevel = appState.user.currentLevel;
                appState.user.progress[oldLanguage].totalXP = appState.user.totalXP;
                appState.user.progress[oldLanguage].lastActive = appState.user.lastActive;
            }
            
            // Reset or load progress for new language
            if (option === 'reset') {
                // Fresh start
                appState.user.completedLevels = [];
                appState.user.currentLevel = 1;
                appState.user.totalXP = 0;
                appState.user.dailyCompleted = 0;
            } else if (option === 'duplicate') {
                // Duplicate current progress
                // Keep as is for fresh start in new language
                appState.user.completedLevels = [];
                appState.user.currentLevel = 1;
                appState.user.totalXP = 0;
                appState.user.dailyCompleted = 0;
            } else if (option === 'preserve') {
                // Try to load previous progress for this language
                if (appState.user.progress[newLanguage]) {
                    appState.user.completedLevels = appState.user.progress[newLanguage].completedLevels || [];
                    appState.user.currentLevel = appState.user.progress[newLanguage].currentLevel || 1;
                    appState.user.totalXP = appState.user.progress[newLanguage].totalXP || 0;
                    appState.user.dailyCompleted = 0;
                } else {
                    // No previous progress, fresh start
                    appState.user.completedLevels = [];
                    appState.user.currentLevel = 1;
                    appState.user.totalXP = 0;
                    appState.user.dailyCompleted = 0;
                }
            }
            
            // Update language
            appState.user.language = newLanguage;
            
            // Load curriculum for new language
            loadCurriculum(newLanguage, () => {
                // Save state
                saveState();
                
                // Update UI
                updateUserUI();
                generateLevels();
                
                // Show confirmation
                const languageName = languageConfigs[newLanguage].name;
                alert(`Language switched to ${languageName}! ${option === 'preserve' ? 'Your previous progress has been loaded.' : 'Starting fresh with this language.'}`);
            });
        }

        // ======================
        // SEGMENT SWITCHING (unchanged)
        // ======================
        
        function showSegmentSelector() {
            const container = document.getElementById('segment-options');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.entries(segmentConfigs).forEach(([key, config]) => {
                const isCurrent = key === appState.user.segment;
                const option = document.createElement('div');
                option.className = `segment-option ${isCurrent ? 'selected' : ''}`;
                option.onclick = (e) => selectSegmentInModal(key, e);
                option.innerHTML = `
                    <div class="segment-icon">${config.name === "Diaspora Parent" ? "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" : 
                                            config.name === "Young Diaspora" ? "üåü" :
                                            config.name === "Professional" ? "üíº" :
                                            config.name === "Marriage/Family" ? "üíï" : "üá≥üá¨"}</div>
                    <div class="segment-title">${config.name}</div>
                    <div class="segment-description">${config.description}</div>
                    ${isCurrent ? '<div style="color: var(--primary); font-size: 12px; font-weight: 600; margin-top: 5px;">Current</div>' : ''}
                `;
                container.appendChild(option);
            });
            
            showModal('segment-modal');
        }

        function selectSegmentInModal(segment, event) {
            if (segment === appState.user.segment) {
                alert("This is already your current learning style!");
                return;
            }
            
            appState.segmentToSwitch = segment;
            
            // Update selection
            document.querySelectorAll('#segment-modal .segment-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show preview
            const config = segmentConfigs[segment];
            document.getElementById('preview-title').textContent = `Preview: ${config.name}`;
            document.getElementById('preview-content').textContent = config.preview;
            document.getElementById('segment-preview').style.display = 'block';
            
            document.getElementById('confirm-segment-btn').disabled = false;
        }

        function confirmSegmentSwitch() {
            if (!appState.segmentToSwitch) return;
            
            appState.user.segment = appState.segmentToSwitch;
            
            // Save state
            saveState();
            
            // Apply new theme
            applySegmentTheme();
            
            // Update UI
            updateUserUI();
            
            // Close modal
            closeModal('segment-modal');
            
            // Show confirmation
            const segmentName = segmentConfigs[appState.segmentToSwitch].name;
            alert(`Learning style switched to ${segmentName}! Content will now be customized for your needs.`);
        }

        // ======================
        // RESET PROGRESS (unchanged)
        // ======================
        
        function showResetModal() {
            showModal('reset-modal');
            
            // Enable reset button when checkbox is checked
            document.getElementById('reset-confirm').addEventListener('change', function() {
                document.getElementById('reset-btn').disabled = !this.checked;
            });
        }

        function resetProgress() {
            if (!document.getElementById('reset-confirm').checked) return;
            
            appState.user.completedLevels = [];
            appState.user.currentLevel = 1;
            appState.user.totalXP = 0;
            appState.user.streak = 0;
            appState.user.dailyCompleted = 0;
            appState.user.favorites = [];
            appState.user.progress = {};
            
            saveState();
            updateUserUI();
            generateLevels();
            
            closeModal('reset-modal');
            alert("Progress reset successfully! You're starting fresh.");
        }

        // ======================
        // PROGRESS IMPORT/EXPORT (unchanged)
        // ======================
        
        function exportProgress() {
            const exportData = {
                version: '1.0.0',
                exportDate: new Date().toISOString(),
                user: appState.user,
                appState: appState
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clearwords-progress-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate imported data
                        if (!importedData.user || !importedData.user.id) {
                            throw new Error("Invalid progress file");
                        }
                        
                        showImportConfirmation(importedData);
                    } catch (error) {
                        alert("Error importing progress: Invalid file format");
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function showImportConfirmation(importedData) {
            document.getElementById('progress-modal-title').textContent = 'Import Progress';
            document.getElementById('progress-modal-content').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì•</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Import Progress Data</div>
                </div>
                
                <div style="background: var(--bg); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>Language:</div>
                        <div style="font-weight: 600;">${languageConfigs[importedData.user.language]?.name || 'Unknown'}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>Completed Levels:</div>
                        <div style="font-weight: 600;">${importedData.user.completedLevels?.length || 0}/50</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>Total XP:</div>
                        <div style="font-weight: 600;">${importedData.user.totalXP || 0} XP</div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <div>Export Date:</div>
                        <div style="font-weight: 600;">${new Date(importedData.exportDate).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background: #FFF5F5; border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #F44336;">‚ö†Ô∏è Warning</div>
                    <div style="color: var(--text-secondary); line-height: 1.5;">
                        Importing will replace your current progress. This action cannot be undone.
                    </div>
                </div>
            `;
            
            document.getElementById('progress-modal-footer').innerHTML = `
                <button class="btn btn-outline" onclick="closeModal('progress-modal')">Cancel</button>
                <button class="btn" style="background: #4CAF50;" onclick="confirmImport(${JSON.stringify(importedData).replace(/"/g, '&quot;')})">Import Progress</button>
            `;
            
            showModal('progress-modal');
        }

        function confirmImport(importedData) {
            appState.user = importedData.user;
            appState.user.id = localStorage.getItem('clearWordsUserId');
            appState.user.lastActive = new Date().toISOString().split('T')[0];
            
            saveState();
            updateUserUI();
            generateLevels();
            
            closeModal('progress-modal');
            alert("Progress imported successfully!");
        }

        // ======================
        // UTILITY FUNCTIONS (unchanged)
        // ======================
        
        function setupNavigation() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showPage(page);
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
                appState.currentPage = pageId;
                
                // Update page-specific content
                if (pageId === 'home') {
                    updateHomeContent();
                } else if (pageId === 'lessons') {
                    generateLevels();
                }
            }
        }

        function updateHomeContent() {
            const user = appState.user;
            const language = languageConfigs[user.language];
            
            if (!language) return;
            
            const continueLesson = document.getElementById('continue-lesson');
            if (!continueLesson) return;
            
            if (user.completedLevels.length === 0) {
                continueLesson.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üöÄ</div>
                        <div style="margin-bottom: 15px; color: var(--text-secondary);">Start your ${language.name} learning journey!</div>
                        <button class="btn" onclick="startLesson(1)">Start Lesson 1</button>
                    </div>
                `;
            } else {
                const nextLevel = user.currentLevel;
                continueLesson.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 16px; font-weight: 600;">Level ${nextLevel}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Ready to continue</div>
                        </div>
                        <button class="btn" onclick="startLesson(${nextLevel})">Continue</button>
                    </div>
                `;
            }
        }

        function updateStreak() {
            const today = new Date().toISOString().split('T')[0];
            const lastActive = appState.user.lastActive;
            
            if (lastActive === today) {
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (lastActive === yesterdayStr) {
                appState.user.streak += 1;
            } else if (lastActive !== today) {
                appState.user.streak = 1;
            }
            
            appState.user.lastActive = today;
            appState.user.dailyCompleted = 1;
        }

        function checkDailyStreak() {
            const today = new Date().toISOString().split('T')[0];
            const lastActive = appState.user.lastActive;
            
            if (lastActive && lastActive !== today) {
                const lastDate = new Date(lastActive);
                const todayDate = new Date(today);
                const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 1) {
                    appState.user.streak = 0;
                    saveState();
                }
            }
        }

        function startSpeedRound() {
            alert("Speed round starting! Complete 3 lessons in 10 minutes for bonus XP!");
            // Implementation would start a timer and track completion
        }

        function toggleTheme() {
            appState.isDarkTheme = !appState.isDarkTheme;
            document.body.classList.toggle('dark-theme', appState.isDarkTheme);
            
            const toggle = document.getElementById('theme-toggle');
            if (toggle) {
                toggle.textContent = appState.isDarkTheme ? 'üåì Dark Mode' : 'üåì Light Mode';
            }
            
            saveState();
        }

        function saveState() {
            localStorage.setItem('clearWordsState', JSON.stringify(appState));
        }

        // ======================
        // MEDIA FUNCTIONS (unchanged)
        // ======================
        
        function playWordAudio(word, language) {
            // This would integrate with a text-to-speech API
            console.log("Playing audio for:", word, "in", language);
            alert(`Playing pronunciation: ${word}`);
            
            // In a real implementation:
            // 1. Use Web Speech API for basic TTS
            // 2. Integrate with language-specific TTS service
            // 3. Use pre-recorded audio files
        }

        function playDialogueLine(index) {
            console.log("Playing dialogue line:", index);
            alert("Playing dialogue line...");
        }

        function playFullDialogue() {
            console.log("Playing full dialogue");
            alert("Playing full dialogue...");
        }

        // ======================
        // GLOBAL FUNCTION EXPORTS
        // ======================
        
        // Make all functions available globally
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.selectSegment = selectSegment;
        window.selectLanguage = selectLanguage;
        window.completeOnboarding = completeOnboarding;
        window.showOnboardingAgain = showOnboardingAgain;
        window.showPage = showPage;
        window.startLesson = startLesson;
        window.startSpeedRound = startSpeedRound;
        window.filterLevels = filterLevels;
        window.searchLessons = searchLessons;
        window.sendChatMessage = sendChatMessage;
        window.handleChatKeyPress = handleChatKeyPress;
        window.clearChat = clearChat;
        window.exportChat = exportChat;
        window.toggleTheme = toggleTheme;
        window.showSegmentSelector = showSegmentSelector;
        window.showLanguageSelector = showLanguageSelector;
        window.showPrivacyPolicy = showPrivacyPolicy;
        window.showTermsOfService = showTermsOfService;
        window.showAbout = showAbout;
        window.showResetModal = showResetModal;
        window.resetProgress = resetProgress;
        window.exportProgress = exportProgress;
        window.importProgress = importProgress;
        window.prevLessonCard = prevLessonCard;
        window.nextLessonCard = nextLessonCard;
        window.selectTestAnswer = selectTestAnswer;
        window.submitTest = submitTest;
        window.closeLessonFlow = closeLessonFlow;
        window.practiceWithTimmy = practiceWithTimmy;
        window.practiceWithPartner = practiceWithPartner;
        window.retryTest = retryTest;
        window.playWordAudio = playWordAudio;
        window.playDialogueLine = playDialogueLine;
        window.playFullDialogue = playFullDialogue;
        window.reviewLesson = reviewLesson;
        window.closeModal = closeModal;
        window.filterLanguages = filterLanguages;
        window.selectLanguageInModal = selectLanguageInModal;
        window.confirmLanguageSwitch = confirmLanguageSwitch;
        window.selectSwitchOption = selectSwitchOption;
        window.proceedWithLanguageSwitch = proceedWithLanguageSwitch;
        window.selectSegmentInModal = selectSegmentInModal;
        window.confirmSegmentSwitch = confirmSegmentSwitch;
        window.printPrivacyPolicy = printPrivacyPolicy;
        window.showTimmyInfo = showTimmyInfo;

        // Helper function for toast notifications
        function showToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                animation: slideUp 0.3s ease;
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Add keyframes for toast animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from { transform: translateX(-50%) translateY(100px); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(0); opacity: 1; }
                to { transform: translateX(-50%) translateY(100px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        console.log("ClearWords app initialized with Timmy AI and 6 languages (including Pidgin)! ü§ì");
    </script>
</body>
</html>